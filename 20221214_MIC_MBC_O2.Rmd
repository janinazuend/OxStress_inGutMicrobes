---
title: "20221214_MIC_MBC_oxygen"
output: html_document
date: '2022-12-14'
---

```{r setup, echo =FALSE}
.libPaths('C:\\Users\\zuendj\\Documents\\R4Libs')
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/zuendj/Desktop/03_data R/tryptophan_enrichment", cho = TRUE, warning = FALSE, message = FALSE)

# Install Packages:
# install.packages("rlang")
# install.packages("tidyr")
# install.packages("ggbreak")
library(dplyr)
library(plyr)
library(tidyverse)
library(ggplot2)
library(tidyr)
# install.packages("devtools")
# devtools::install_github("slowkow/ggrepel")
library(ggrepel)
library(ggbreak)
# install.packages("openxlsx")
library(openxlsx)
```

# 1. Load the Data
```{r}
#########################################
#Load the data
########################################

setwd("P:/Shared_documents/Janina Zünd/08_phd/09_student thesis/Marina/03_experimentation/03_MIC_MBC/01_OD-measurements/single_bacteria_for_plot")
bacteria <- list.files(path = "P:/Shared_documents/Janina Zünd/08_phd/09_student thesis/Marina/03_experimentation/03_MIC_MBC/01_OD-measurements/single_bacteria_for_plot")

options(scipen=999)
#########################################
#load the data
########################################

#define empty matrices, no values added so far 
MIC_values<- matrix(0, length(bacteria)*6, 12)
MIC_average<- matrix(0, length(bacteria), 12)

MBC_values<- matrix(0, length(bacteria)*6, 12)
MBC_average<- matrix(0, length(bacteria), 12)



#MIC, fill values into MIC, here OD corrected values, but not corrected with agar 
row = 0
for (l in 1:length(bacteria)) {
  #generate MICwide format
  MICwide = read.csv(bacteria[l], sep=";", header=F, check.names =F)
  #look for A indicating the area in the excel file with the data

  for (r in 35:42) {
    if (MICwide[r,1]=="C") {
      zeile = r
    }
  }
#########################################
  for(i in 1:12) {
    #x indicated the colum->'A' is in column 1 and the data next to it from column 2 on
    x = 1+i
    zeile_end = zeile+6
    d = as.numeric(unlist(data.frame(MICwide[zeile:zeile_end, x])))
    for(j in 1:6){
      y = d[j]
      MIC_values[row+j, i] = y
      }
  }
  
  #########################################
  #generate averages 
  for(i in 1:12) {
    r1= row+1
    r2= row+6
    MIC_average[l, i] = as.numeric(mean(MIC_values[r1:r2, i],  na.rm = TRUE))
  }
  
  row=row+6
  
}  

#MBC, fill values into MBC, here OD corrected values, but not corrected with agar 
row = 0
for (l in 1:length(bacteria)) {
  #generate MICwide format
  MICwide = read.csv(bacteria[l], sep=";", header=F, check.names =F)
  #look for A indicating the area in the excel file with the data
  for (r in 49:56) {
    if (MICwide[r,1]=="C") {
      zeile = r
    }
  }
  #########################################
  for(i in 1:12) {
    #x indicated the colum->'A' is in column 1 and the data next to it from column 2 on
    x = 1+i
    zeile_end = zeile+6
    d = as.numeric(unlist(data.frame(MICwide[zeile:zeile_end, x])))
    for(j in 1:6){
      y = d[j]
      MBC_values[row+j, i] = y
    }
  }
  
  #########################################
  #generate averages 
  for(i in 1:12) {
    r1= row+1
    r2= row+6
    MBC_average[l, i] = as.numeric(mean(MBC_values[r1:r2, i],  na.rm = TRUE))
  }
  
  row=row+6
  
}  


#########################################
#define row names for the blank corrected 
row_names<-matrix(0,length(bacteria)*6,1)
position = 0
for (i in 1:length(bacteria)) {
  for (j in 1:6) {
    row_names[position+j,1] = bacteria[i]
  }
  position = position+6
}

```


# 4. Get the MIC for individual repleciates
```{r}
#########################################
#define row names for the blank corrected 
bacteria <- strsplit(bacteria, ".csv")
bacteria <- as.character(bacteria)


row_names<-matrix(0,length(bacteria)*6,1)
position = 0
for (i in 1:length(bacteria)) {
  for (j in 1:6) {
    row_names[position+j,1] = bacteria[i]
  }
  position = position+6
}

MIC_replicates <-data.frame(row_names, MIC_values)
colnames(MIC_replicates)<-list("bacteria",  2.2, 4.7, 10.3, 22.4, 48.85, 106.3, 231.4, 503.5, 1095.9 , 2385.2 , 5191.4, 11299.08 )

MBC_replicates <-data.frame(row_names, MBC_values)
colnames(MBC_replicates)<-list("bacteria", 2.2, 4.7, 10.3, 22.4, 48.85, 106.3, 231.4, 503.5, 1095.9, 2385.2, 5191.4, 11299.08 )
```

```{r}
av_mbc<- aggregate(MBC_replicates[,2], list(MBC_replicates$bacteria), FUN=mean)
colnames(av_mbc)<-c("bacteria", "average")
MBC_replicates_mean<-join(MBC_replicates, av_mbc, by=c("bacteria"))
av_mic<- aggregate(MIC_replicates[,2], list(MIC_replicates$bacteria), FUN=mean)
colnames(av_mic)<-c("bacteria", "average")
MIC_replicates_mean<-join(MIC_replicates, av_mic, by=c("bacteria"))
```

```{r}
ggplot(MIC_replicates, aes(y=MIC_replicates[,1], x= MIC_replicates[,3]))+
  geom_boxplot()
```



# 5. Export blanck corrected OD values for outlier correction
```{r}
write.xlsx(MBC_replicates, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MBC_O2_replicates.xlsx")
write.xlsx(MIC_replicates, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_O2_replicates.xlsx")

MIC_replicates ->backup_mic_rep
MBC_replicates ->backup_mbc_rep

##outlier correction

MIC_replicates[1,c("503.5")]<-0
MIC_replicates[3,c("11299.08")]<-0
MIC_replicates[37,c("2385.2")]<-0
MIC_replicates[94,c("11299.08")]<-0
MIC_replicates[103,c("1095.9")]<-0
MIC_replicates[105,c("11299.08")]<-0
MIC_replicates[133,c("2.2")]<-NA
MIC_replicates[135,c("2.2")]<-NA
MIC_replicates[138,c("2.2")]<-NA


MBC_replicates[1,c("503.5")]<-0
MBC_replicates[31,c("2.2")]<-NA
MBC_replicates[c(50, 52, 134, 173),c("2.2")]<-NA
MBC_replicates[105,c("11299.08")]<-0
MBC_replicates[173,c("2385.2")]<-0
MBC_replicates[176,c("48.85")]<-0

```


```{r}

average<-aggregate(MIC_replicates$`2.2`, list(MIC_replicates$bacteria), FUN=mean, na.rm=TRUE, na.action=NULL)
names(average)<-c("bacteria", "average")
MIC_mod_av<-join(MIC_replicates, average)



average<-aggregate(MBC_replicates$`2.2`, list(MBC_replicates$bacteria), FUN=mean, na.rm=TRUE, na.action=NULL)
names(average)<-c("bacteria", "average")
MBC_mod_av<-join(MBC_replicates, average)

MIC_mod_av[is.na(MIC_mod_av)] <- 0
MBC_mod_av[is.na(MBC_mod_av)] <- 0


MIC_vector <- vector()
for (i in 1:nrow(MIC_mod_av)) { #vertical 
  candidates <- vector()
     for(j in 2:13) {#horizontal 
       if (MIC_mod_av[i,j]>0.02 & MIC_mod_av[i,j]/MIC_mod_av[i, 14]>0.10) {#-> MIC_value_absolut)

         candidates <- append(candidates, colnames(MIC_mod_av)[j])
         candidates <-as.numeric(candidates)
       }
     }
  MIC_vector <- append(MIC_vector, max(candidates))
}


MBC_vector <- vector()
for (i in 1:nrow(MBC_mod_av)) { #vertical 
  candidates <- vector()
  for(j in 2:13) {#horizontal 
    if (MBC_mod_av[i,j]>0.02 & MBC_mod_av[i,j]/MBC_mod_av[i, 14]>0.10) {#-> MIC_value_absolut)
      
      candidates <- append(candidates, colnames(MBC_mod_av)[j])
      candidates <-as.numeric(candidates)
    }
  }
  MBC_vector <- append(MBC_vector, max(candidates))
}

```

```{r}
final_replicates <- matrix(0, length(row_names), 5)
final_replicates[, 1] <- row_names
final_replicates[, 2] <- as.numeric(MIC_vector)
final_replicates[, 3] <- as.numeric(MBC_vector)
final_replicates[, 4] <-MBC_vector
final_replicates[,5]<-"in_range"

#convert matrix into a data frame
df_final_replicates=as.data.frame(final_replicates)



#naming columns of the dataframe_final
col_names <- list("bacteria", "MIC","MBC", "MBC_factor", "range")
colnames(df_final_replicates) <-col_names


df_long<-gather(df_final_replicates, condition, value, "MIC":"MBC", factor_key = T)




df_long$value<-as.numeric(df_long$value)

df_long$MBC_factor<-as.numeric(df_long$MBC_factor)


```

```{r}
library(ggbreak)
df_long$condition<-factor(df_long$condition, levels=c("MBC", "MIC"))

length(bacteria)

df_long%>%
  mutate(bacteria = fct_reorder(bacteria, df_long$MBC_factor))%>%
  ggplot(aes(y=bacteria))+
  stat_summary(fun="median", geom= "bar", aes(x= value, fill=condition), position= position_dodge(preserve = "single"), width= 0.8, alpha=0.5, colour= "black")+
  geom_point(aes(x=value, colour=condition, group=condition), position=position_jitterdodge(jitter.width = 0.2,
  jitter.height = 0.05,
  dodge.width = 0.75,
  seed = NA), alpha=1, size=1)+
  scale_color_manual(values=c("goldenrod2", "cyan4"))+
  scale_fill_manual(values=c("goldenrod2", "cyan4"))+
  ggtitle(expression(MIC~and~MBC~of~O[2]))+
  xlab("Oxygenation")+
  # facet_grid(cols=vars(range), scales="free", space="free")+
  # force_panelsizes(cols = c(5, 0.3))+
  scale_x_break(breaks=c(6500, 9000))+
  scale_x_log10(breaks=c( 2.2, 4.8, 10.6, 23.4, 51.5, 113.4, 249.4, 548.8, 1207.3, 2656, 5843.2), position = "bottom")+
  theme(axis.text.y= element_text(size = 15 , face = "italic"), 
        axis.title.y = element_blank(), 
        axis.title.x = element_text(size=20),
        axis.text.x = element_text(size=15, angle=90),
        legend.text = element_text(size = 15),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20),
        axis.text.x.top=element_blank(),
        axis.ticks.x.top =  element_blank()
        )+
  guides(fill=guide_legend(title="Assay") ,colour="none")

ggsave(filename = "MIC_MBC_O2.jpeg", 
       path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/output", 
       width = 18,
       height = 25,
       units = c("cm"))


```
# 6. Export MIC/MBC values
```{r}
library(readr)
setwd( "C:/Users/zuendj/Desktop/03_data R/oxidative stress")
names(df_long)[5]<-"value_O2"
names(df_long)[4]<-"condition_O2"
# Write the first data set in a new workbook
write.csv(df_long[,c(1,4,5)], file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_MBC_O2.csv")
```



