---
title: "20221214_MIC_MBC_oxygen"
output: html_document
date: '2022-12-14'
---

```{r setup, echo =FALSE}
.libPaths('C:\\Users\\zuendj\\Documents\\R4Libs')
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/zuendj/Desktop/03_data R/tryptophan_enrichment", cho = TRUE, warning = FALSE, message = FALSE)

# Install Packages:
# install.packages("rlang")
# install.packages("tidyr")
# install.packages("ggbreak")
library(dplyr)
library(plyr)
library(tidyverse)
library(ggplot2)
library(tidyr)
# install.packages("devtools")
# devtools::install_github("slowkow/ggrepel")
library(ggrepel)
library(ggbreak)
# install.packages("openxlsx")
library(openxlsx)
```

# 1. Load the Data
```{r}
#########################################
#Load the data
########################################

setwd("P:/Shared_documents/Janina Zünd/08_phd/09_student thesis/Marina/03_experimentation/03_MIC_MBC/01_OD-measurements/single_bacteria_for_plot")
bacteria <- list.files(path = "P:/Shared_documents/Janina Zünd/08_phd/09_student thesis/Marina/03_experimentation/03_MIC_MBC/01_OD-measurements/single_bacteria_for_plot")

options(scipen=999)
#########################################
#load the data
########################################

#define empty matrices, no values added so far 
MIC_values<- matrix(0, length(bacteria)*6, 12)
MIC_average<- matrix(0, length(bacteria), 12)

MBC_values<- matrix(0, length(bacteria)*6, 12)
MBC_average<- matrix(0, length(bacteria), 12)



#MIC, fill values into MIC, here OD corrected values, but not corrected with agar 
row = 0
for (l in 1:length(bacteria)) {
  #generate MICwide format
  MICwide = read.csv(bacteria[l], sep=";", header=F, check.names =F)
  #look for A indicating the area in the excel file with the data

  for (r in 35:42) {
    if (MICwide[r,1]=="C") {
      zeile = r
    }
  }
#########################################
  for(i in 1:12) {
    #x indicated the colum->'A' is in column 1 and the data next to it from column 2 on
    x = 1+i
    zeile_end = zeile+6
    d = as.numeric(unlist(data.frame(MICwide[zeile:zeile_end, x])))
    for(j in 1:6){
      y = d[j]
      MIC_values[row+j, i] = y
      }
  }
  
  #########################################
  #generate averages 
  for(i in 1:12) {
    r1= row+1
    r2= row+6
    MIC_average[l, i] = as.numeric(mean(MIC_values[r1:r2, i],  na.rm = TRUE))
  }
  
  row=row+6
  
}  

#MBC, fill values into MBC, here OD corrected values, but not corrected with agar 
row = 0
for (l in 1:length(bacteria)) {
  #generate MICwide format
  MICwide = read.csv(bacteria[l], sep=";", header=F, check.names =F)
  #look for A indicating the area in the excel file with the data
  for (r in 49:56) {
    if (MICwide[r,1]=="C") {
      zeile = r
    }
  }
  #########################################
  for(i in 1:12) {
    #x indicated the colum->'A' is in column 1 and the data next to it from column 2 on
    x = 1+i
    zeile_end = zeile+6
    d = as.numeric(unlist(data.frame(MICwide[zeile:zeile_end, x])))
    for(j in 1:6){
      y = d[j]
        MBC_values[row+j, i] = y
    }
  }
  
  #########################################
  #generate averages 
  for(i in 1:12) {
    r1= row+1
    r2= row+6
    MBC_average[l, i] = as.numeric(mean(MBC_values[r1:r2, i],  na.rm = TRUE))
  }
  
  row=row+6
  
}  


#########################################
```


# 4. Get the MIC for individual repleciates
```{r}
#########################################
#define row names for the blank corrected 
bacteria <- strsplit(bacteria, ".csv")
bacteria <- as.character(bacteria)


row_names<-matrix(0,length(bacteria)*6,1)
position = 0
for (i in 1:length(bacteria)) {
  for (j in 1:6) {
    row_names[position+j,1] = bacteria[i]
  }
  position = position+6
}

MIC_replicates <-data.frame(row_names, MIC_values)
colnames(MIC_replicates)<-list("bacteria",  2.2, 4.7, 10.3, 22.4, 48.85, 106.3, 231.4, 503.5, 1095.9 , 2385.2 , 5191.4, 11299.08 )

MBC_replicates <-data.frame(row_names, MBC_values)
colnames(MBC_replicates)<-list("bacteria", 2.2, 4.7, 10.3, 22.4, 48.85, 106.3, 231.4, 503.5, 1095.9, 2385.2, 5191.4, 11299.08 )
```


# 5. Export blanck corrected OD values for outlier correction
```{r}
write.xlsx(MBC_replicates, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MBC_O2_replicates.xlsx")
write.xlsx(MIC_replicates, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_O2_replicates.xlsx")

MBC_replicates<-read.xlsx("C:/Users/zuendj/Desktop/03_data R/oxidative stress/MBC_O2_replicates_mod.xlsx")
MIC_replicates<-read.xlsx("C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_O2_replicates_mod.xlsx")
```


```{r}
#get long format
average_long<-gather(MIC_replicates, condition, OD, "1":"13", factor_key = T )
#take averages of the technical replicate
average_long_tec<-set_names(aggregate(average_long$OD, list(average_long$bacteria, average_long$replicate, average_long$condition), FUN=mean, na.rm=TRUE), colnames(average_long))
#get average per condition -> to get max
average<-set_names(aggregate(average_long_tec$OD, list(average_long_tec$bacteria, average_long_tec$condition), FUN=mean, na.rm=TRUE), c("bacteria", "condition" ,"average"))
# find max
max_mic<-set_names(aggregate(average$average, by = list(average$bacteria), max, na.rm=TRUE), c("bacteria", "max"))

MIC_replicates_wide<-pivot_wider(average_long_tec, names_from = condition , values_from = OD)

average_long<-gather(MBC_replicates, condition, OD, "1":"13", factor_key = T )
average_long_tec<-set_names(aggregate(average_long$OD, list(average_long$bacteria, average_long$replicate, average_long$condition), FUN=mean, na.rm=TRUE), colnames(average_long))
average<-aggregate(average_long_tec$OD, list(average_long_tec$bacteria, average_long_tec$condition), FUN=mean, na.rm=TRUE)
names(average)<-c("bacteria", "condition" ,"average")
max_mbc<-set_names(aggregate(average$average, by = list(average$bacteria), max, na.rm=TRUE), c("bacteria", "max"))

MBC_replicates_wide<-pivot_wider(average_long_tec, names_from = condition , values_from = OD)

MIC_mod_av<-left_join(MIC_replicates_wide, max_mic)
MBC_mod_av<-left_join(MBC_replicates_wide, max_mbc)




MIC_vector <- vector()
for (i in 1:nrow(MIC_mod_av)) { #vertical 
  candidates <- vector()
     for(j in 3:14) {#horizontal 
       if (!is.na(MIC_mod_av[i,j]) & MIC_mod_av[i,j]/MIC_mod_av[i, "max"]>0.1 & MIC_mod_av[i,j]>0.0336) {#-> MIC_value_absolut)

         candidates <- append(candidates, colnames(MIC_mod_av)[j])
         candidates <-as.numeric(candidates)
       }
     }
  MIC_vector <- append(MIC_vector, max(candidates))
}

# trial to see if results make sense to set limit at 10% of the growth of the control
# | MBC_mod_av[i,j]/MBC_mod_av[i, 14]>0.10

MBC_vector <- vector()
for (i in 1:nrow(MBC_mod_av)) { #vertical 
  candidates <- vector()
  for(j in 3:14) {#horizontal 
    if (!is.na(MBC_mod_av[i,j]) & MBC_mod_av[i,j]/MBC_mod_av[i, "max"]>0.1 & MBC_mod_av[i,j]>0.0336 ) {#-> MIC_value_absolut)
      
      candidates <- append(candidates, colnames(MBC_mod_av)[j])
      candidates <-as.numeric(candidates)
    }
  }
  MBC_vector <- append(MBC_vector, max(candidates))
}


```

```{r}
#assign vectors with MIC/MBCs to daf

df_final_replicates <- data.frame(bacteria = MIC_mod_av$bacteria, 
                                  replicate = MIC_mod_av$replicate,
                                  MIC = as.numeric(MIC_vector), 
                                  MBC = as.numeric(MBC_vector))


order<-aggregate(df_final_replicates$MBC, by=list(df_final_replicates$bacteria), mean)
colnames(order) <-c("bacteria", "order")

df_final_replicates<-left_join(df_final_replicates, order)

df_long<-gather(df_final_replicates, assay, value, "MIC":"MBC", factor_key = T)

df_long$value<-as.numeric(df_long$value)

```

## Go back to the heatplot with relative od values
```{r}
MBC_rel<-MBC_mod_av
MIC_rel<-MIC_mod_av

for (i in 1:nrow(MIC_rel)) { #vertical 
  for(j in 3:14) {#horizontal 
     MIC_rel[i,j] = MIC_rel[i,j]/MIC_rel[i, c("max")] 
  }}

for (i in 1:nrow(MBC_rel)) { #vertical 
  for(j in 3:14) {#horizontal 
     MBC_rel[i,j] = MBC_rel[i,j]/MBC_rel[i, c("max")] 
  }}


# MBC_relgrowth_value<-cbind(MBC_rel, df_final_replicates)
# MIC_relgrowth_value<-cbind(MIC_rel, df_final_replicates)


MIC_rel_long<-gather(MIC_rel, condition, OD, "1":"13", factor_key = T)
MIC_rel_long$assay<-c("MIC")
MBC_rel_long<-gather(MBC_rel, condition, OD, "1":"13", factor_key = T)
MBC_rel_long$assay<-c("MBC")

MBC_MIC_rel_long<-rbind(MIC_rel_long, MBC_rel_long)
MBC_MIC_rel_long<-left_join(MBC_MIC_rel_long, df_long)

```


```{r}
MBC_MIC_rel_long$OD[MBC_MIC_rel_long$OD <0.1]<-0
MBC_MIC_rel_long$condition<-as.numeric(paste(MBC_MIC_rel_long$condition))


for (i in 1:nrow(MBC_MIC_rel_long)){
  if ( MBC_MIC_rel_long[i, c("condition")] == MBC_MIC_rel_long[i, c("value")]) { 
    MBC_MIC_rel_long[i, c("label")] = MBC_MIC_rel_long[i, c("value")]}}

MBC_MIC_rel_long$label<-as.numeric(MBC_MIC_rel_long$label)
```


```{r}

MBC_MIC_rel_long$label<-MBC_MIC_rel_long$label+1
MBC_MIC_rel_long$OD[MBC_MIC_rel_long$condition == 13]<-NA


MBC_MIC_rel_long%>%
  subset(!bacteria %in% c("Subdoligranulum variable", "Anaerobutyricum hallii", "Marvinbryantia formatixigens", "Ruminococcus bromii"))%>%
  drop_na(OD)->hoi

hoi%>%
  mutate(bacteria = fct_reorder(bacteria, hoi$order))%>%
  ggplot(aes(x = condition, y = assay, fill = OD)) + 
  geom_raster() +
  # scale_fill_continuous(limits=c(0, 2), breaks = c(0,0.5, 1, 1.5, 2))+
  labs(x=expression(paste("Oxygenation")))+
  theme(text = element_text(size=15), 
        axis.text.x = element_text(angle = 90, vjust= 0.5, hjust=1),
        axis.title.y= element_blank(),
        axis.text.y=element_text(size=10),
        strip.text.y = element_text(angle = 0, face = "italic", hjust=0),
        strip.background = element_blank())+
  facet_grid(rows =vars(bacteria), scales = "free", space = "free")+
  geom_point(aes(x=label, y=assay, color=assay), alpha=0.5, position=position_jitterdodge(jitter.width = 0.3, jitter.height = 0.1))+
  # geom_text(aes(label=label, color=assay))+
  scale_x_continuous(labels=c("0","2.2", 
                              "4.8",  
                              "10.6", 
                              "23.4", 
                              "51.5", 
                              "113",  
                              "249",
                              "549",
                              "1207",
                              "2656",  
                              "5843",  ">tested"), 
                     breaks=c(1, 2, 3, 4, 5, 6, 7,  8 ,9 ,10, 11, 12, 13))+
  labs(fill = expression(relative~OD[600]), colour="")+
  ggtitle(expression(MIC~and~MBC~of~O[2]))



ggsave(filename = "MIC_MBC_o2_groeth.jpeg", 
       path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/output", 
       width = 18,
       height = 30,
       units = c("cm"))



```


# 6. Export MIC/MBC values
```{r}
library(readr)
setwd( "C:/Users/zuendj/Desktop/03_data R/oxidative stress")
names(df_long)[5]<-"value_O2"
names(df_long)[4]<-"condition_O2"
# Write the first data set in a new workbook
write.csv(df_long[,c(1,4,5)], file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_MBC_O2.csv")
```



