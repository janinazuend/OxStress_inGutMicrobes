---
title: "C-sources & 8 donors"
---

Link to Florentin's github page: https://htmlpreview.github.io/?https://github.com/fconstancias/DivComAnalyses/blob/master/SOP/community_analyses/Microbiome_R_tutorial.html#alpha-diversity

1. Getting ready: load all packages
-newest version of R
-rtools required 


```{r setup, echo =FALSE}
.libPaths('C:\\Users\\zuendj\\Documents\\R4Libs')
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "P:/Shared_documents/Serafina Pl√ºss/20230320_sequencing_results/Janina", cho = TRUE, warning = FALSE, message = FALSE)

# library("plyr")
# install.packages("vctrs")
# install.packages("vegan")
# install.packages("cli")

# library(vctrs)
# library(vegan)
# install.packages("ggplot2")
#library(ggplot2)
#install.packages('tinytex')
#install.packages('rmarkdown')
#install.packages("rlang")
#install.packages("nlme")
#install.packages("mgcv")
#install.packages("ape")
#library(nlme)
# install.packages("remotes")
# remotes::install_github("mikemc/speedyseq")
# install.packages("BiocManager")
# BiocManager::install("DESeq2")
#install.packages("fs")
# install.packages('devtools')
#install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
#unload("mia")
# install.packages("GUniFrac")

# install.packages(
#   "microViz",
#   repos = c(davidbarnett = "https://david-barnett.r-universe.dev", getOption("repos"))
# )


 # devtools::install_github("tidyverse/tidyverse")
 #  library(tidyverse)
 library(openxlsx)
# # install.packages("ggalluvial")
# library(ggalluvial)
 # library(ggh4x)
# library(GUniFrac)
  library(rstatix)
# library(tinytex)
# library(rmarkdown)
# library(rlang) 
 library(tidyverse)
   library(microViz)
# library(dplyr)
# library(mgcv)
# library(ape)
# library(phyloseq)
# library(speedyseq)
# library(DESeq2)
  # library(plyr)
# library(fs)
# library(devtools)
# library(pairwiseAdonis)
library(ggpubr)

 # install.packages("dplyr")
# install.packages("data.table")
# devtools::install_github("vmikk/metagMisc")
#  
# library(metagMisc)


```

```{r, echo =FALSE}
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_taxa_tests.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_normalisation.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_alpha.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_beta.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_heatmap.R")
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_taxa_tests.R")
source("https://raw.githubusercontent.com/fconstancias/metabaRpipe-source/master/Rscripts/functions.R")
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_varia.R")
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_beta.R")

#get metadata file: load this function
sample.data.frame <- function(ps) {
  return(as(phyloseq::sample_data(ps), "data.frame"))}
```
## 1. Get the phyloseq object 
```{r}
# unloadNamespace("miaViz")
# unloadNamespace("mia")

phyloseq <-readRDS("P:/Shared_documents/Janina_Zuend/08_phd/01_sequencing_data/Ox_stress/phyloseq.RDS")
phyloseq%>%
  phyloseq_get_strains()->phyloseq
```

```{r}
hplc<-read.xlsx("C:/Users/zuendj/Desktop/03_data R/wp2_complex/input/20230613_hplc_list_results_stress.xlsx")
hplc%>%
  subset(!sample_name %in% NA)->hplc

seq<-read.xlsx("P:/Shared_documents/Janina_Zuend/08_phd/01_sequencing_data/Ox_stress/mapping_file.xlsx")

meta<-left_join(seq, hplc[,c(1:12)])
write.xlsx(meta, "P:/Shared_documents/Janina_Zuend/08_phd/01_sequencing_data/Ox_stress/meta_new.xlsx")
```
### Get and update metadata file
```{r, echo=FALSE}

phyloseq%>%
  physeq_add_metadata(physeq = .,
                      metadata = "P:/Shared_documents/Janina_Zuend/08_phd/01_sequencing_data/Ox_stress/meta.xlsx" %>%
                        readxl::read_xlsx(),
                      sample_column = "sample_name") -> phyloseq

as.data.frame(sample_data(phyloseq))->meta
## remove donor 2 from data as very low sample size
# phyloseq %>%
#   subset_samples(!donor_name %in% "D1")->phyloseq



```
###Filtering
```{r}
ps_strain_filt <- phyloseq

# threshold in %
threshold = 0.1

# filter per sample to remove all ASV lower in abundance than threshold (%)
otu_table(ps_strain_filt) <- otu_table(ps_strain_filt) %>%
  as.data.frame() %>%
  dplyr:: mutate(across(everything(), ~ ifelse(. <= sum(.) * (threshold/100), 0, .))) %>% otu_table(., taxa_are_rows = TRUE)

# remove all ASVs that are not present in any sample
ps_strain_filt <- ps_strain_filt %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE)
```

#Rarefying
```{r}
# phyloseq%>%
ps_strain_filt%>%
  phyloseq_check_lib_size(data_color = "donor_name",
                          data_facet = NULL,
                          nreads_display = 3165,
                       first_n = nsamples(phyloseq)) -> lib

ps_strain_filt%>%
# phyloseq %>%
  rarefy_even_depth(rngseed = 123,
                    sample.size = 2900
                    # sample.size = 5000
                    ) -> phyloseq_rare
```

#A) Alpha diversity
#Alpha: passages of controls
```{r}
#H2O2
###Line plot########################################################################################
names<-list("diversity_shannon"= "Shannon", 
            "observed"= "Observed")

phyloseq_rare%>%
  subset_samples(time %in% "feces" | time %in% "pre-stress" | (stress_level %in% c("control") & stress %in% c("H2O2", "O2") & incubation %in% "anaerobe"))%>%
     # subset_samples(stress %in% c("H2O2", "control"))%>%
  phyloseq_alphas(phylo = TRUE)%>%
  mutate(time = factor(time, levels=c("feces","pre-stress", "stress", "post_stress_1", "post_stress_2")))%>%
  gather(index, value, "observed":"diversity_shannon")%>%
  ggplot(aes(x=time, y=value))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90, hjust=1),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot(outlier.shape =  NA)+
  geom_jitter(aes(colour=donor_name), width=0.1)+
  facet_grid(rows=vars(index), scales="free", labeller=facet_labeller)+
  ylab("Alpha diversity")+
  labs(colour="Donor")+
  scale_x_discrete(labels = c("feces", "pre-culture", "P1", "P2", "P3"))+
  ggtitle("Alpha diversity of ex-vivo cultures")


ggsave(filename = "alpha_cultures.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output",
       width = 17,
       height = 17,
       units = c("cm"))
```
#H2O2 alpha dist absolute

```{r}
phyloseq_rare%>% 
  phyloseq_alphas(phylo = TRUE)%>%
  subset(stress %in% "H2O2" & !time %in% "pre-stress")%>%
  mutate(stress_level = factor(stress_level, levels=c("control", "low", "median", "high")),
         time = factor(time, levels=c( "stress", "post_stress_1", "post_stress_2")))-> sub

sub%>%
  group_by(time)%>%
  wilcox_test(data= .,
  formula = diversity_shannon ~ stress_level, ref.group = "control" , p.adjust.method = "BH"
  )%>%
  add_significance()%>%
  subset(!p.adj.signif %in% "ns")%>%
  add_y_position()->stat_test


names<-list("stress"= "Stress", 
            "post_stress_1"= "Post 1", 
            "post_stress_2"= "Post 2")

sub%>%
  ggplot(aes(x=stress_level, y=diversity_shannon))+
  theme(text = element_text(size=15), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=15, angle = 90, vjust= 0.5, hjust=1),
        axis.title.y= element_text(size=15),
        axis.text.y=element_text(size=15),
        strip.text.y = element_text(),
        strip.background = element_blank(),
        axis.ticks.y = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size= 15),
        plot.title = element_text(size=20, hjust=0.25),
        strip.text = element_text(size=15), 
        panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA))+
  geom_boxplot(aes(fill=stress_level), outlier.shape = NA, position = position_dodge2(preserve = "single"))+
 geom_jitter(aes(colour=donor_name),  width = 0.1)+
  # ggtitle(expression('??Alpha'~'diversity:'~H[2]*O[2]~vs.~control))+
  ylab("Shannon-Index")+
  labs(colour="Donor", fill="Stress level")+
   scale_fill_manual(values=c("skyblue2","skyblue3", "lightpink3", "lightpink4"))+
  facet_grid(cols=vars(time),scales= "free", labeller=facet_labeller) +
   stat_pvalue_manual(stat_test, label = "p.adj.signif", hide.ns = T)->p


show(p + theme (legend.position = "none"))

ggsave(filename = paste( "alpha_h2o2_delta.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/H2O2/alpha",
       width = 14,
       height = 7,
       units = c("cm"))


```


#alpha comapred to control ==>Distances
```{r}

phyloseq_rare%>% 
  phyloseq_alphas(phylo = TRUE)-> alphas

###ad control value to all stress-level
alphas%>%
  subset(stress %in% "H2O2" & stress_level %in% "control")->low
low$stress_level <- "low"
low$stress <- "control"

alphas%>%
  subset(stress %in% "H2O2" & stress_level %in% "control")->median
median$stress_level <- "median"
median$stress <- "control"


alphas%>%
  subset(stress %in% "H2O2" & stress_level %in% "control")->high
high$stress_level <- "high"
high$stress <- "control"

rbind(subset(alphas, stress %in% "H2O2"), low, median, high)->alphas_comparison

names<-list("stress"= "Stress", 
            "post_stress_1"= "Post 1", 
            "post_stress_2"= "Post 2")


alphas_comparison[, c("donor_name", "time", "stress_level", "stress", "diversity_shannon")]%>%
  subset(!stress_level %in% "control" & !time %in% "pre-stress")%>%
  pivot_wider(values_from = diversity_shannon, names_from = stress)%>%
  mutate(diff = H2O2-control)%>%
  mutate(stress_level = factor(stress_level, levels=c( "low", "median", "high")),
         time = factor(time, levels=c( "stress", "post_stress_1", "post_stress_2"))) %>%
  ggplot(aes(x=stress_level, y=diff))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle = 90, vjust= 0.5, hjust=1),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot( outlier.shape = NA, position = position_dodge2(preserve = "single"))+
  geom_jitter(aes(colour=donor_name),  width = 0.1)+
  ggtitle(expression('??Alpha'~'diversity:'~H[2]*O[2]~vs.~control))+
  ylab("??Shannon-Index")+
  labs(colour="Donor", fill="Stress level")+
  facet_grid(cols=vars(time),scales= "free", labeller=facet_labeller) +
  geom_hline(yintercept=0, linetype=2)->p

p



ggsave(filename = paste( "alpha_h2o2_delta.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/H2O2/alpha",
       width = 25,
       height = 10,
       units = c("cm"))

```


#Alpha: upon oxygen stress
```{r}
#O2: aerobic
phyloseq_rare%>% 
     subset_samples( stress %in% "control" | (stress %in% "O2" ))%>%
  phyloseq_alphas(phylo = TRUE) -> alphas


names<-list("stress"= "Stress", 
            "post_stress_1"= "Post 1", 
            "post_stress_2"= "Post 2")

facet_labeller <- function(variable,value){
  return(names[value])
}


alphas%>%
  subset(!time %in% c("pre-stress"))%>%
  mutate(stress_level = factor(stress_level, levels=c("control", "low", "median", "high", "max")),
         time = factor(time, levels=c( "stress", "post_stress_1", "post_stress_2"))) %>%
  ggplot(aes(x=stress_level, y=diversity_shannon))+
  scale_fill_manual(values=c( "pink4","skyblue3"), labels=c("Control", "Stress"))+
 theme(text = element_text(size=15), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=15, angle = 90, vjust= 0.5, hjust=1),
        axis.title.y= element_text(size=15),
        axis.text.y=element_text(size=15),
        strip.text.y = element_text(),
        strip.background = element_blank(),
        axis.ticks.y = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size= 15),
        plot.title = element_text(size=20, hjust=0.25),
        strip.text = element_text(size=15), 
        panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA))+
  geom_boxplot(aes(fill=incubation), outlier.shape = NA, position = position_dodge2(preserve = "single"))+
   geom_point(aes(colour=donor_name, group=incubation), position = position_jitterdodge(0.1))+
  # ggtitle("Alpha diversity")+
  scale_x_discrete(labels=c("minimal", "low", "median", "high", "max"))+
  ylab("Shannon-Index")+
  labs(colour="Donor", fill="Condition")+
   # force_panelsizes(rows = unit(c(1,2,2), "cm"),
   #                 cols = unit(11, "cm"))+
  facet_grid(cols=vars(time), labeller=facet_labeller)+
  guides(alpha = guide_legend(override.aes = list(fill = "darkgrey"))) +
  ylim(2, 4)

  # stat_pvalue_manual(stat_test, label = "p.signif", hide.ns = T)
  
  x<-paste(stress_level_cond[i])

ggsave(filename = paste(x, "O2_alpha_o2_shannon.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2/alpha",
       width = 16.5,
       height = 7,
       units = c("cm"))

```

#Alpha compared to control ==>Distances
```{r}
alphas[, c("donor_name", "time", "stress_level", "stress", "observed", "incubation")]%>%
  subset(!time %in% "pre-stress")%>%
  pivot_wider(values_from = observed, names_from = incubation)%>%
  mutate(diff = aerobe - anaerobe)%>%
  mutate(stress_level = factor(stress_level, levels=c( "control","low", "median", "high", "max")),
         time = factor(time, levels=c( "stress", "post_stress_1", "post_stress_2"))) %>%
  ggplot(aes(x=stress_level, y=diff))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle = 90, vjust= 0.5, hjust=1),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot( outlier.shape = NA, position = position_dodge2(preserve = "single"))+
  geom_jitter(aes(colour=donor_name),  width = 0.1)+
  ggtitle(expression('??Alpha'~'diversity:'~O[2]~vs.~control))+
  ylab("??Shannon-Index")+
  labs(colour="Donor", fill="Stress level")+
  facet_grid(cols=vars(time),scales= "free", labeller=facet_labeller) +
  geom_hline(yintercept=0, linetype=2)+
  # ylim(-1, 0.5)+
  scale_x_discrete(labels=c("minimal", "low", "median", "high", "max"))



ggsave(filename = paste( "alpha_o2_delta.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2/alpha",
       width = 25,
       height = 10,
       units = c("cm"))
  

```
#stats
```{r}
alphas%>%
  subset(!time %in% c("pre-stress"))%>%
  group_by(time, stress_level) %>%
  t_test(data= .,
  formula = diversity_shannon ~ incubation ,
  )%>%
  add_significance()->wil
```

#B) Beta diversity
#Calculations of distances: control culture vs. subsequent passages
```{r}
phyloseq_rare %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1", "feces"))%>%
  subset_samples(!donor_name %in% NA)-> sub

# sub %>%
#   microbiome::transform("clr") -> ps_transformed

sub%>%
  phyloseq::distance(method = "bray") -> bc

sub %>%
  ordinate(method = "PCoA",
           distance = bc) -> ord

sub %>% 
  phyloseq_distance_boxplot(p = ., 
                            dist = bc, 
                            d = "time") -> out # column in metadata for comparaisons

setNames(as.data.frame(out$matrix),c("sample_name", "sample_name_comp", "value", "condition_comp", "comparison")) -> distances

distances%>%
  subset(comparison %in% c("pre-stress"))-> distances

joined<-left_join(distances, sample.data.frame(sub)[,c(1,7:12)])

joined%>%
  mutate(sample_name_comp = recode(sample_name_comp, "M-09" = 'D1',
                                   "M-10" = 'D2',
                                   "M-11" = 'D3',
                                   "M-12" = 'D4',
                                   "M-13" = 'D5',
                                   "M-14" = 'D6',
                                   "M-15" = 'D7',
                                   "M-16" = 'D8',))->joined

for (i in 1:nrow(joined)){
  if (joined[i,c("donor_name")] == joined[i,c("sample_name_comp")]){joined[i,c("match")]= "true"}
}

joined%>%
  subset(match %in% "true")->match

# match$condition_comp<-factor(match$condition_comp, levels=c("control","protein_YCFA"))
```
##beta dist. over all passages (over all controls)
```{r}
match%>%
  subset(stress_level %in% c("control") & stress %in% c("H2O2", "O2") & incubation %in% c("anaerobe"))%>%
  mutate(time = factor(time, levels=c("stress", "post_stress_1", "post_stress_2")))%>%
  ggplot(aes(x=time, y=value))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20),  panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot(outlier.shape=NA)+
  geom_jitter(aes(colour=donor_name), width=0.1)+
  ylab("Aitchison dsitance")+
  ggtitle("Beta distance between pre-cultures and passages")+
    scale_x_discrete(labels=c("P1", "P2", "P3"))+
  labs(colour="Donor")

ggsave(filename = paste("beta_controls.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output",
       width = 17,
       height = 10,
       units = c("cm"))

```

#H2O2
```{r}
match%>%
  subset(stress %in% "H2O2" )%>%
  ggplot(aes(x=time, y=value))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20),  panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_line(aes(colour=stress_level, group=stress_level), size=1)+
  facet_grid( cols=vars(donor_name))+
  geom_point(aes(colour=stress_level, group=stress_level))+
  ggtitle("Beta dist.: pre-stress vs. culures:H2O2")

ggsave(filename = "Beta_dist_H2O2.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/H2O2",
       width = 30,
       height = 17,
       units = c("cm"))

match$stress_level<-factor(match$stress_level, levels=c("control", "low", "median", "high", "max"))

names<-list("pre-stress" = "Pre", 
            "stress"= "Stress", 
            "post_stress_1"= "Post 1", 
            "post_stress_2"= "Post 2")

facet_labeller <- function(variable,value){
  return(names[value])
}




match%>%
  subset(stress %in% "H2O2" )%>%
  ggplot(aes(x=stress_level, y=value))+
  # scale_fill_manual(values=c("steelblue4", "steelblue3",  "coral2", "coral3"))+
 theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle = 90, vjust= 0.5, hjust=1),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot(outlier.shape = NA, position = position_dodge2(preserve = "single"))+
  geom_point(aes(colour=donor_name, group=stress_level), position = position_jitterdodge(0.2))+
  ggtitle("Beta distance to pre-culture")+
  # scale_x_discrete(labels=c("Stress", "Post 1", "Post 2"))+
  ylab("Aitchison distance")+
  labs(colour="Donor", fill="Stress level") +
  facet_grid(cols=vars(time), labeller=facet_labeller)

ggsave(filename = paste("beta_h2o2_pre-culture.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/H2O2",
       width = 25,
       height = 12,
       units = c("cm"))


```


#O2
```{r}
match$time<-factor(match$time, levels=c("pre-stress", "stress", "post_stress_1", "post_stress_2"))
match$stress_level<-factor(match$stress_level, levels=c("control", "low", "median", "high", "max"))

match%>%
  subset(stress %in% "O2" )%>%
  ggplot(aes(x=time, y=value))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
   geom_line(aes(colour=stress_level, group=stress_level), size=1)+
  facet_grid( cols=vars(donor_name, incubation))+
  geom_point(aes(colour=stress_level, group=stress_level))+
  ggtitle("Beta dist.: pre-stress vs. culures:anaerobic controls")

ggsave(filename = "Beta_dist_O2_anaerobe.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2",
       width = 40,
       height = 17,
       units = c("cm"))

names<-list("pre-stress" ="pre",
            "stress"= "Stress", 
            "post_stress_1"= "Post 1", 
            "post_stress_2"= "Post 2"
            )



match%>%
  subset(stress %in% "O2" )%>%
  ggplot(aes(x=stress_level, y=value))+
  theme(strip.text = element_text(size  = 20),
        axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
   geom_boxplot(aes(fill=incubation), outlier.shape = NA)+
  facet_grid(cols=vars(time), labeller=facet_labeller )+
  scale_fill_manual(values=c("skyblue3", "lightpink3"), labels=c("Control", "Stress"), name="Condition")+
  geom_point(aes(colour=donor_name, group=incubation), position = position_jitterdodge(0.02), alpha=0.8)+
  ggtitle("Beta distance to pre-culture")+
  ylab("Aitchison distance")+
labs(colour = "Donor")

ggsave(filename = "Beta_dist_box-pre-culture.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2/beta",
       width = 25,
       height = 12,
       units = c("cm"))



234.2/40*25

```
###ADONIS
```{r}
time <- c("stress", "post_stress_1", "post_stress_2")
stress_level_cond <-c("low", "median", "high")

for (i in 1:length(time)){

  phyloseq_rare %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1", "feces"))%>%
     subset_samples(!donor_name %in% c("D1", "D5"))%>%
  subset_samples(stress %in% "O2") %>%
    subset_samples(time %in% time[i])->sub
  
  sub%>%
  phyloseq::distance(method = "bray") -> bc
    
    vegan::adonis2(bc ~ get_variable(sub,"incubation") , p.adjust.methods= "BH")->adonis
    
    
    
  print(c(time[i]))
  print(adonis)
  }

```

#Distance between control conditions: H2O2
```{r}

phyloseq_rare %>%
  # subset_samples(time %in% "stress")%>%
  subset_samples(stress %in% c("H2O2"))-> sub

sub %>%
  microbiome::transform("clr") -> ps_transformed

ps_transformed%>%
  phyloseq::distance(method = "euclidean") -> bc

ps_transformed %>%
  ordinate(method = "PCoA",
           distance = bc) -> ord
ps_transformed %>% 
  phyloseq_distance_boxplot(p = ., 
                            dist = bc, 
                            d = "stress_level") -> out# column in metadata for comparaisons

setNames(as.data.frame(out$matrix),c("sample_name", "sample_name_comp", "value", "condition_comp", "comparison")) -> distances

distances%>%
  subset(comparison %in% c("control"))-> distances

joined<-left_join(distances, sample.data.frame(sub)[,c(1,7:12)])

sample_name<-setNames(sample.data.frame(sub)[,c("sample_name", "donor_name", "time")], c("sample_name_comp", "donor_comp", "time_comp"))


joined_2<-left_join(joined, sample_name)
 

for (i in 1:nrow(joined_2)){
  if (joined_2[i,c("donor_name")] == joined_2[i,c("donor_comp")] & joined_2[i,c("time")] == joined_2[i,c("time_comp")]){joined_2[i,c("match")]= "true"}
}

joined_2%>%
  subset(match == c("true"))-> match_h2o2
```

```{r}
match_h2o2$stress_level<-factor(match_h2o2$stress_level, levels=c("low", "median", "high"))
match_h2o2$time<-factor(match_h2o2$time, levels=c("stress", "post_stress_1", "post_stress_2"))

names<-list("stress"= "Stress", 
            "post_stress_1"= "Post 1", 
            "post_stress_2"= "Post 2")

facet_labeller <- function(variable,value){
  return(names[value])
}


match_h2o2%>%
 subset(stress %in% "H2O2" )%>%
  ggplot(aes(x=stress_level, y=value))+
  # scale_fill_manual(values=c("steelblue3",  "coral2", "coral3"))+
 theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(size=20, angle = 90, vjust= 0.5, hjust=1),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot( outlier.shape = NA, position = position_dodge2(preserve = "single"))+
  geom_point(aes(colour=donor_name, group=stress_level), position = position_jitterdodge(0.05))+
  ggtitle(expression('Beta'~distances~between~H[2]*O[2]~and~control))+
  # scale_x_discrete(labels=c("Stress", "Post 1", "Post 2"))+
  ylab("Aitchison distance")+
  labs(colour="Donor", fill="Stress level") +
  facet_grid(cols=vars(time), scale="free", labeller=facet_labeller)
   # force_panelsizes(rows = unit(8, "cm"),
   #                 cols = unit(11, "cm"))

ggsave(filename = paste("beta_h2o2.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/H2O2",
       width = 25,
       height = 10,
       units = c("cm"))
```

```{r}

time <- c("stress", "post_stress_1", "post_stress_2")
stress_level_cond <-c( "low", "median", "high")

for (i in 1:length(time)){
  for (j in 1:length(stress_level_cond)){
  phyloseq_rare %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1", "feces"))%>%
  subset_samples(stress %in% "H2O2") %>%
    subset_samples(time %in% time[i]) %>%
    subset_samples(stress_level %in% c("control", stress_level_cond[j]))->sub
  
  sub %>%
  microbiome::transform("clr") -> ps_transformed

ps_transformed%>%
  phyloseq::distance(method = "euclidean") -> bc

ps_transformed %>% 
  physeq_betadisper(dm = bc,
                    variable = "stress_level") -> betadisp    
    
print(length(get_variable(sub,"stress_level")))  
    
  print(c(time[i], stress_level_cond[j]) )
  print(betadisp)
  }}


```

```{r}
# source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_beta.R")
time <- c("stress", "post_stress_1", "post_stress_2")
stress_level_cond <-c("low", "median", "high")

for (i in 1:length(time)){

  phyloseq_rare %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1", "feces"))%>%
  subset_samples(stress %in% "O2" & incubation %in% "aerobe") %>%
    subset_samples(time %in% time[i] ) ->sub
  
sub %>%
  phyloseq::distance(method = "bray") -> bc
  
  sub%>%
    physeq_pairwise_permanovas_adonis2(dm = bc,
                                     compare_header = "stress_level") %>% 
  arrange(pvalFDR)->p
    
    
  print(c(time[i]))
  print(p)
  }

```
#Distance between control conditions: O2
```{r}
phyloseq_rare %>%
  # subset_samples(time %in% "stress")%>%
  subset_samples(stress %in% c("O2"))-> sub

# sub %>%
#   microbiome::transform("clr") -> ps_transformed

sub%>%
  phyloseq::distance(method = "bray") -> bc

ps_transformed %>%
  ordinate(method = "PCoA",
           distance = bc) -> ord
sub %>% 
  phyloseq_distance_boxplot(p = ., 
                            dist = bc, 
                            d = "incubation") -> out -> out # column in metadata for comparaisons

setNames(as.data.frame(out$matrix),c("sample_name", "sample_name_comp", "value", "condition_comp", "comparison")) -> distances

distances%>%
  subset(comparison %in% c("anaerobe"))-> distances

joined<-left_join(distances, sample.data.frame(sub)[,c(1,7:12)])

sample_name<-setNames(sample.data.frame(sub)[,c("sample_name", "incubation", "donor_name", "time", "stress_level")], c("sample_name_comp", "incubation_comp","donor_comp", "time_comp", "stress_level_comp"))


joined_2<-left_join(joined, sample_name)
 

for (i in 1:nrow(joined_2)){
  if ((joined_2[i,c("condition_comp")] != joined_2[i,c("incubation_comp")]) & 
      (joined_2[i,c("donor_name")] == joined_2[i,c("donor_comp")]) & 
      (joined_2[i,c("time")] == joined_2[i,c("time_comp")]) &
      (joined_2[i,c("stress_level")] == joined_2[i,c("stress_level_comp")])) {joined_2[i,c("match")]= "true"}
}

joined_2%>%
  subset(match == c("true"))-> match_o2
```
```{r}
match_o2$stress_level<-factor(match_o2$stress_level, levels=c("control","low", "median", "high", "max"))
match_o2$time<-factor(match_o2$time, levels=c("stress", "post_stress_1", "post_stress_2"))

names<-list("stress"= "Stress", 
            "post_stress_1"= "Post 1", 
            "post_stress_2"= "Post 2")

facet_labeller <- function(variable,value){
  return(names[value])
}

match_o2%>%
  # subset(stress_level %in% c("control", "median", "max"))%>%
  ggplot(aes(x=stress_level, y=value))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(size=20, angle = 90, vjust= 0.5, hjust=1),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
   geom_boxplot( outlier.shape = NA)+
  geom_jitter(aes(colour=donor_name, group=stress_level), position = position_jitterdodge(0.05))+
   ggtitle(expression('Beta'~distances~between~O[2]~and~control))+
  scale_x_discrete(labels=c("minimal", "low", "medium", "high", "max"))+
  ylab("Aitchison distance")+
  labs(colour="Donor", fill="Stress level") +
  facet_grid(cols=vars(time), scale="free", labeller=facet_labeller)+
  ylim(10, 30)->p

p
  


ggsave(filename = paste(x, "O2_alpha_o2.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2/beta",
       width = 25,
       height = 10,
       units = c("cm"))


```

```{r}

time <- c("stress", "post_stress_1", "post_stress_2")
stress_level_cond <-c("control", "low", "median", "high", "max")

for (i in 1:length(time)){
  for (j in 1:length(stress_level_cond)){
  phyloseq_rare %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1", "feces"))%>%
  subset_samples(stress %in% "O2") %>%
    subset_samples(time %in% time[i]) %>%
    subset_samples(stress_level %in% c(stress_level_cond[j]))->sub
  
  sub %>%
  microbiome::transform("clr") -> ps_transformed

ps_transformed%>%
  phyloseq::distance(method = "euclidean") -> bc

ps_transformed %>% 
  physeq_betadisper(dm = bc,
                    variable = "incubation") -> betadisp    
    
print(length(get_variable(sub,"incubation")))  
    
  print(c(time[i], stress_level_cond[j]) )
  print(betadisp)
  }}


```


```{r}
time <- c("stress", "post_stress_1", "post_stress_2")
stress_level_cond <-c("control", "low", "median", "high", "max")

for (i in 1:length(time)){
  for (j in 1:length(stress_level_cond)){
  phyloseq_rare %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1", "feces"))%>%
  subset_samples(stress %in% "O2" | !donor_name %in% c("D1")) %>%
    subset_samples(time %in% time[i]) %>%
    subset_samples(stress_level %in% c(stress_level_cond[j]))->sub
  
  sub %>%
  microbiome::transform("clr") -> ps_transformed

ps_transformed%>%
  phyloseq::distance(method = "euclidean") -> bc
    
    vegan::adonis2(bc ~ get_variable(sub,"incubation") , p.adjust.methods= "BH")->adonis
    
print(length(get_variable(sub,"incubation")))  
    
  print(c(time[i], stress_level_cond[j]) )
  print(adonis)
  }}

```

```{r}
phyloseq_rare %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1", "feces"))%>%
  subset_samples(stress %in% "O2" ) %>%
  subset_samples(time %in% "stress")%>%
  # subset_samples(stress_level %in% c("high", "max"))%>%
    subset_samples(incubation %in% "anaerobe")->sub
  
 sub %>%
  microbiome::transform("clr") -> ps_transformed

ps_transformed%>%
  phyloseq::distance(method = "euclidean") -> bc
    
    vegan::adonis2(bc ~ get_variable(sub,"stress_level")  , p.adjust.methods= "BH")->adonis
    
    
    
  print(c(time[i], stress_level_cond[j]))
  print(adonis)

```


# PCoA -02 aerobic incubation anaerobic incubation
```{r}
library(plyr)


phyloseq_rare %>%
  subset_samples(time %in% c("stress"))%>%
   # subset_samples(time %in% c("post_stress_2", "post_stress_1"))%>%
   # subset_samples(!donor_name %in% c("D1", "D5"))%>%
  # subset_samples(stress_level %in% c("max"))%>%
  subset_samples(stress %in% c("O2"))-> sub


  dist = "bray"
  ord_meths = c("PCoA")


  plist = llply(as.list(ord_meths), function(i, sub, dist){
          ordi = ordinate(sub, method=i, distance=dist)
          plot_ordination(physeq = sub, 
                          ordination = ordi,
                          color = "donor_name", 
                          shape = "stress",
                          title = "PCoA Bray-Curtis", 
                          label= "time")},
          sub, 
          dist)


  names(plist) <- ord_meths

  pdataframe = ldply(plist, function(x){
      df = x$data[, 1:2]
      colnames(df) = c("Axis_1", "Axis_2")
      return(cbind(df, x$data))})


  
  names(pdataframe)[1] = "method"


  pdataframe%>%
      ggplot(aes(Axis_1, Axis_2))+ 
        scale_colour_manual(values=c( "lightpink3","skyblue3"), labels=c("Control", "Stress"), name="Condition")+
    scale_shape_manual(values= c(15,  16, 17, 0, 1, 2, 3, 4), name="Donor")+
      geom_point(aes(colour=incubation, shape=donor_name), size=4, stroke=1.5, alpha=.85)+
    stat_ellipse(aes(group=incubation, colour=incubation))+
      theme(axis.text.y= element_text(size = 20), 
          axis.title.y = element_text(size=20), 
          axis.title.x = element_text(size=20),
          axis.text.x = element_text(size=20),
          legend.text = element_text(size = 20),
          legend.title = element_text(size= 20),
          plot.title = element_text(size=20), 
          legend.text.align = 0, 
        panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA))+
    xlab("PCoA1 (27.1%)")+
    ylab("PCoA2 (19.3%)")+
    ggtitle("Stress")
  
  ggsave(filename = paste("O2_beta_stress.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2/beta",
       width = 16,
       height = 11,
       units = c("cm"))  
  
  
  phyloseq_rare %>%
  # subset_samples(time %in% c("stress"))%>%
    subset_samples(time %in% c("post_stress_2", "post_stress_1"))%>%
    # subset_samples(!donor_name %in% c( "D1", "D5"))%>%
  # subset_samples(stress_level %in% c("max"))%>%
  subset_samples(stress %in% c("O2"))-> sub


  dist = "bray"
  ord_meths = c("PCoA")


  plist = llply(as.list(ord_meths), function(i, sub, dist){
          ordi = ordinate(sub, method=i, distance=dist)
          plot_ordination(physeq = sub, 
                          ordination = ordi,
                          color = "donor_name", 
                          shape = "stress",
                          title = "PCoA Bray-Curtis", 
                          label= "time")},
          sub, 
          dist)


  names(plist) <- ord_meths

  pdataframe = ldply(plist, function(x){
      df = x$data[, 1:2]
      colnames(df) = c("Axis_1", "Axis_2")
      return(cbind(df, x$data))})


  
  names(pdataframe)[1] = "method"


  pdataframe%>%
      ggplot(aes(Axis_1, Axis_2))+ 
        scale_colour_manual(values=c( "lightpink3","skyblue3"), labels=c("Control", "Stress"), name="Condition")+
    scale_shape_manual(values= c(15,  16, 17, 0, 1, 2, 3, 4), name="Donor")+
      geom_point(aes(colour=incubation, shape=donor_name), size=4, stroke=1.5, alpha=.85)+
    stat_ellipse(aes(group=incubation, colour=incubation))+
      theme(axis.text.y= element_text(size = 20), 
          axis.title.y = element_text(size=20), 
          axis.title.x = element_text(size=20),
          axis.text.x = element_text(size=20),
          legend.text = element_text(size = 20),
          legend.title = element_text(size= 20),
          plot.title = element_text(size=20), 
          legend.text.align = 0, 
        panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA))+
    xlab("PCoA1 (20.6%)")+
    ylab("PCoA2 (18.6%)")+
    ggtitle("Post-stress")
  
  
    ggsave(filename = paste("O2_beta_post.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2/beta",
       width = 16,
       height = 11,
       units = c("cm"))
  
  
```

# PCoA -02 stress levels

```{r}
library(plyr)


phyloseq_rare %>%
  subset_samples(time %in% c("stress") & incubation %in% "aerobe")%>%
   # subset_samples(time %in% c("post_stress_2", "post_stress_1"))%>%
   # subset_samples(!donor_name %in% c("D1", "D5"))%>%
  # subset_samples(stress_level %in% c("max"))%>%
  subset_samples(stress %in% c("O2"))-> sub


  dist = "bray"
  ord_meths = c("PCoA")


  plist = llply(as.list(ord_meths), function(i, sub, dist){
          ordi = ordinate(sub, method=i, distance=dist)
          plot_ordination(physeq = sub, 
                          ordination = ordi,
                          color = "donor_name", 
                          shape = "stress",
                          title = "PCoA Bray-Curtis", 
                          label= "time")},
          sub, 
          dist)


  names(plist) <- ord_meths

  pdataframe = ldply(plist, function(x){
      df = x$data[, 1:2]
      colnames(df) = c("Axis_1", "Axis_2")
      return(cbind(df, x$data))})


  
  names(pdataframe)[1] = "method"


  pdataframe%>%
      ggplot(aes(Axis_1, Axis_2))+ 
        # scale_colour_manual(values=c("skyblue3", "lightpink3"), labels=c("Control", "Stress"), name="Condition")+
    scale_shape_manual(values= c(15,  16, 17, 0, 1, 2, 3, 4), name="Donor")+
      geom_point(aes(colour=stress_level, shape=donor_name), size=4, stroke=1.5, alpha=.85)+
    stat_ellipse(aes(group=stress_level, colour=incubation))+
      theme(axis.text.y= element_text(size = 20), 
          axis.title.y = element_text(size=20), 
          axis.title.x = element_text(size=20),
          axis.text.x = element_text(size=20),
          legend.text = element_text(size = 20),
          legend.title = element_text(size= 20),
          plot.title = element_text(size=20), 
          legend.text.align = 0, 
        panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA))+
    xlab("PCoA1 (27.1%)")+
    ylab("PCoA2 (19.3%)")
  
  ggsave(filename = paste("O2_beta_stress.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2/beta",
       width = 16,
       height = 11,
       units = c("cm"))  
  
  
  phyloseq_rare %>%
  # subset_samples(time %in% c("stress"))%>%
    subset_samples(time %in% c("post_stress_2", "post_stress_1"))%>%
    # subset_samples(!donor_name %in% c( "D1", "D5"))%>%
  # subset_samples(stress_level %in% c("max"))%>%
  subset_samples(stress %in% c("O2"))-> sub


  dist = "bray"
  ord_meths = c("PCoA")


  plist = llply(as.list(ord_meths), function(i, sub, dist){
          ordi = ordinate(sub, method=i, distance=dist)
          plot_ordination(physeq = sub, 
                          ordination = ordi,
                          color = "donor_name", 
                          shape = "stress",
                          title = "PCoA Bray-Curtis", 
                          label= "time")},
          sub, 
          dist)


  names(plist) <- ord_meths

  pdataframe = ldply(plist, function(x){
      df = x$data[, 1:2]
      colnames(df) = c("Axis_1", "Axis_2")
      return(cbind(df, x$data))})


  
  names(pdataframe)[1] = "method"


  pdataframe%>%
      ggplot(aes(Axis_1, Axis_2))+ 
        scale_colour_manual(values=c( "lightpink3","skyblue3"), labels=c("Control", "Stress"), name="Condition")+
    scale_shape_manual(values= c(15,  16, 17, 0, 1, 2, 3, 4), name="Donor")+
      geom_point(aes(colour=incubation, shape=donor_name), size=4, stroke=1.5, alpha=.85)+
    stat_ellipse(aes(group=incubation, colour=incubation))+
      theme(axis.text.y= element_text(size = 20), 
          axis.title.y = element_text(size=20), 
          axis.title.x = element_text(size=20),
          axis.text.x = element_text(size=20),
          legend.text = element_text(size = 20),
          legend.title = element_text(size= 20),
          plot.title = element_text(size=20), 
          legend.text.align = 0, 
        panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA))+
    xlab("PCoA1 (20.6%)")+
    ylab("PCoA2 (18.6%)")
  
  
    ggsave(filename = paste("O2_beta_post.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2/beta",
       width = 16,
       height = 11,
       units = c("cm"))
  
  
```


# PCoA -H202
```{r}
# library(plyr)


phyloseq_rare %>%
  # subset_samples(time %in% "stress")%>%
  # subset_samples(!donor_name %in% c("D1", "D5"))%>%
   subset_samples(stress_level %in% c("control","low","median","high"))%>%
  subset_samples(stress %in% c("H2O2") & time %in% "stress")-> sub


  dist = "bray"
  ord_meths = c("PCoA")


  plist = llply(as.list(ord_meths), function(i, sub, dist){
          ordi = ordinate(sub, method=i, distance=dist)
          plot_ordination(physeq = sub, 
                          ordination = ordi,
                          color = "donor_name", 
                          shape = "stress",
                          title = "PCoA Bray-Curtis", 
                          label= "time")},
          sub, 
          dist)


  names(plist) <- ord_meths

  pdataframe = ldply(plist, function(x){
      df = x$data[, 1:2]
      colnames(df) = c("Axis_1", "Axis_2")
      return(cbind(df, x$data))})


  
  names(pdataframe)[1] = "method"


  pdataframe%>%
    mutate(stress_level = factor(stress_level, levels=c("control", "low", "median", "high")))->sub
      ggplot(data=sub, aes(Axis_1, Axis_2))+ 
        stat_ellipse(data = subset(sub, time %in% "stress"), aes(group=stress_level, fill=stress_level), geom="polygon", alpha=0.2, lty=1, size=1.5)+
         # stat_ellipse(data = subset(sub, time %in% "post_stress_2"), aes(group=stress_level, colour=stress_level), lty=2, size=1, alpha=.8)+
      geom_point(aes(colour=stress_level, shape=donor_name), size=4, alpha=0.8)+
      theme(axis.text.y= element_text(size = 20), 
          axis.title.y = element_text(size=20), 
          axis.title.x = element_text(size=20),
          axis.text.x = element_text(size=20),
          legend.text = element_text(size = 20),
          legend.title = element_text(size= 20),
          plot.title = element_text(size=20), 
          legend.text.align = 0, 
        panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA))+
    scale_colour_manual(values=c("skyblue2","skyblue3", "lightpink3", "lightpink4"), 
                        # labels=c("control", expression("222"~mu*M), expression("710"~mu*M),  "2.3 mM"))+
                        labels=c("control", "low", "median", "high"), name="Stress level")+
     scale_fill_manual(values=c("skyblue2","skyblue3", "lightpink3", "lightpink4"), name="Stress level")+
     scale_shape_manual(values= c(15,  16, 17, 0, 1, 2, 3, 4), name="Donor")+
  xlab("PCoA1 (30.6 %)")+
    ylab("PCoA2 (14 %)")+
    scale_alpha_manual(values=c(1, 0.7, 0.6))+
        ggtitle("Stress")
      
      ggsave(filename = paste("H2O2_beta_ocoa.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/H2O2/beta",
       width = 16,
       height = 18,
       units = c("cm"))
      
      
      phyloseq_rare %>%
  # subset_samples(time %in% "stress")%>%
  # subset_samples(!donor_name %in% c("D1", "D5"))%>%
   subset_samples(stress_level %in% c("control","low","median","high"))%>%
  subset_samples(stress %in% c("H2O2") & !time %in% "stress")-> sub


  dist = "bray"
  ord_meths = c("PCoA")


  plist = llply(as.list(ord_meths), function(i, sub, dist){
          ordi = ordinate(sub, method=i, distance=dist)
          plot_ordination(physeq = sub, 
                          ordination = ordi,
                          color = "donor_name", 
                          shape = "stress",
                          title = "PCoA Bray-Curtis", 
                          label= "time")},
          sub, 
          dist)


  names(plist) <- ord_meths

  pdataframe = ldply(plist, function(x){
      df = x$data[, 1:2]
      colnames(df) = c("Axis_1", "Axis_2")
      return(cbind(df, x$data))})


  
  names(pdataframe)[1] = "method"


  pdataframe%>%
    mutate(stress_level = factor(stress_level, levels=c("control", "low", "median", "high")))->sub
      ggplot(data=sub, aes(Axis_1, Axis_2))+ 
        stat_ellipse(aes(group=stress_level, fill=stress_level), geom="polygon", alpha=0.2, lty=1, size=1.5)+
      geom_point(aes(colour=stress_level, shape=donor_name), size=4, alpha=0.8)+
      theme(axis.text.y= element_text(size = 20), 
          axis.title.y = element_text(size=20), 
          axis.title.x = element_text(size=20),
          axis.text.x = element_text(size=20),
          legend.text = element_text(size = 20),
          legend.title = element_text(size= 20),
          plot.title = element_text(size=20), 
          legend.text.align = 0, 
        panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA))+
    scale_colour_manual(values=c("skyblue2","skyblue3", "lightpink3", "lightpink4"), 
                        # labels=c("control", expression("222"~mu*M), expression("710"~mu*M),  "2.3 mM"))+
                        labels=c("control", "low", "median", "high"), name="Stress level")+
     scale_fill_manual(values=c("skyblue2","skyblue3", "lightpink3", "lightpink4"), name="Stress level")+
     scale_shape_manual(values= c(15,  16, 17, 0, 1, 2, 3, 4), name="Donor")+
  xlab("PCoA1 (29.9 %)")+
    ylab("PCoA2 (14.4 %)")+
    scale_alpha_manual(values=c(1, 0.7, 0.6))+
        ggtitle("Post-stress")
      
      ggsave(filename = paste("H2O2_beta_post.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/H2O2/beta",
       width = 16,
       height = 10,
       units = c("cm"))

  
  
```


# PCOa - controls
```{r}
library(plyr)


phyloseq_rare %>%
   subset_samples( time %in% "pre-stress" | (stress_level %in% c("control") & stress %in% c("H2O2", "O2") & incubation %in% "anaerobe"))-> sub


  dist = "bray"
  ord_meths = c("PCoA")


  plist = llply(as.list(ord_meths), function(i, sub, dist){
          ordi = ordinate(sub, method=i, distance=dist)
          plot_ordination(physeq = sub, 
                          ordination = ordi,
                          color = "donor_name", 
                          shape = "stress",
                          title = "PCoA Bray-Curtis", 
                          label= "time")},
          sub, 
          dist)


  names(plist) <- ord_meths

  pdataframe = ldply(plist, function(x){
      df = x$data[, 1:2]
      colnames(df) = c("Axis_1", "Axis_2")
      return(cbind(df, x$data))})


  
  names(pdataframe)[1] = "method"


  pdataframe%>%  mutate(time = factor(time, levels = c("pre-stress", "stress", "post_stress_1", "post_stress_2")))%>%
      ggplot(aes(Axis_1, Axis_2))+ 
      # scale_color_manual(values=c('darkgoldenrod1', "cyan4"))+
      geom_point(aes(shape=time, colour=donor_name), size=4, stroke=1.5, alpha=0.8)+
    stat_ellipse(aes(group=donor_name, colour=donor_name))+
      theme(axis.text.y= element_text(size = 20), 
          axis.title.y = element_text(size=20), 
          axis.title.x = element_text(size=20),
          axis.text.x = element_text(size=20),
          legend.text = element_text(size = 20),
          legend.title = element_text(size= 20),
          plot.title = element_text(size=20), 
          legend.text.align = 0, 
        panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA))  +
    scale_shape_manual(values=c(  21, 15, 16, 17), labels=c( "Pre-culture", "P1", "P2", "P3"), name="Condition")+
    labs(colour="Donor")+
    xlab("PCoA (21.9%)")+
    ylab("PCoA (16%)")+
    ggtitle("Beta diversity of ex-vivo cultures")
  
  ggsave(filename =  "Beta_div.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output",
       width = 17,
       height = 14,
       units = c("cm"))
```





```{r}
physeq_1_rare %>% 
  phyloseq_plot_bdiv(dlist = dlist, # list of distance computed from a phyloseq object
                     ps_rare = ., # phyloseq object
                     m = "PCoA", # PCoA or NMDS
                     seed = 123, # for reproducibility
                     axis1 = 1, # axis to plot
                     axis2 = 2) -> plot_list
```


