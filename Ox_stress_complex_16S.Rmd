---
title: "C-sources & 8 donors"
---

Link to Florentin's github page: https://htmlpreview.github.io/?https://github.com/fconstancias/DivComAnalyses/blob/master/SOP/community_analyses/Microbiome_R_tutorial.html#alpha-diversity

1. Getting ready: load all packages
-newest version of R
-rtools required 


```{r setup, echo =FALSE}
.libPaths('C:\\Users\\zuendj\\Documents\\R4Libs')
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "P:/Shared_documents/Serafina Pl√ºss/20230320_sequencing_results/Janina", cho = TRUE, warning = FALSE, message = FALSE)

# library("plyr")
# install.packages("vctrs")
# install.packages("vegan")
# install.packages("cli")

# library(vctrs)
# library(vegan)
# install.packages("ggplot2")
#library(ggplot2)
#install.packages('tinytex')
#install.packages('rmarkdown')
#install.packages("rlang")
#install.packages("nlme")
#install.packages("mgcv")
#install.packages("ape")
#library(nlme)
# install.packages("remotes")
# remotes::install_github("mikemc/speedyseq")
# install.packages("BiocManager")
# BiocManager::install("DESeq2")
#install.packages("fs")
# install.packages('devtools')
#install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
#unload("mia")
# install.packages("GUniFrac")

# install.packages(
#   "microViz",
#   repos = c(davidbarnett = "https://david-barnett.r-universe.dev", getOption("repos"))
# )


 devtools::install_github("tidyverse/tidyverse")
 library(tidyverse)
  library(openxlsx)
# # install.packages("ggalluvial")
# library(ggalluvial)
 # library(ggh4x)
# library(GUniFrac)
  library(rstatix)
# library(tinytex)
# library(rmarkdown)
# library(rlang) 
# library(tidyverse)
 library(microViz)
# library(dplyr)
# library(mgcv)
# library(ape)
# library(phyloseq)
# library(speedyseq)
# library(DESeq2)
  library(plyr)
# library(fs)
# library(devtools)
# library(pairwiseAdonis)
 library(ggpubr)

# install.packages("dplyr")
# install.packages("data.table")
# devtools::install_github("vmikk/metagMisc")
#  
# library(metagMisc)


```

```{r, echo =FALSE}
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_taxa_tests.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_normalisation.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_alpha.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_beta.R") 
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_heatmap.R")
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_taxa_tests.R")
source("https://raw.githubusercontent.com/fconstancias/metabaRpipe-source/master/Rscripts/functions.R")
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_varia.R")
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_beta.R")

#get metadata file: load this function
sample.data.frame <- function(ps) {
  return(as(phyloseq::sample_data(ps), "data.frame"))}
```
## 1. Get the phyloseq object 
```{r}
# unloadNamespace("miaViz")
# unloadNamespace("mia")

phyloseq <-readRDS("P:/Shared_documents/Janina_Zuend/08_phd/01_sequencing_data/Ox_stress/phyloseq.RDS")
phyloseq%>%
  phyloseq_get_strains()->phyloseq
```

```{r}
hplc<-read.xlsx("C:/Users/zuendj/Desktop/03_data R/wp2_complex/input/20230613_hplc_list_results_stress.xlsx")
hplc%>%
  subset(!sample_name %in% NA)->hplc

seq<-read.xlsx("P:/Shared_documents/Janina_Zuend/08_phd/01_sequencing_data/Ox_stress/mapping_file.xlsx")

meta<-left_join(seq, hplc[,c(1:12)])
write.xlsx(meta, "P:/Shared_documents/Janina_Zuend/08_phd/01_sequencing_data/Ox_stress/meta_new.xlsx")
```
### Get and update metadata file
```{r, echo=FALSE}

phyloseq%>%
  physeq_add_metadata(physeq = .,
                      metadata = "P:/Shared_documents/Janina_Zuend/08_phd/01_sequencing_data/Ox_stress/meta.xlsx" %>%
                        readxl::read_xlsx(),
                      sample_column = "sample_name") -> phyloseq

as.data.frame(sample_data(phyloseq))->meta
## remove donor 2 from data as very low sample size
# phyloseq %>%
#   subset_samples(!donor_name %in% "D1")->phyloseq



```
```{r}
ps_strain_filt <- phyloseq

# threshold in %
threshold = 0.25

# filter per sample to remove all ASV lower in abundance than threshold (%)
otu_table(ps_strain_filt) <- otu_table(ps_strain_filt) %>%
  as.data.frame() %>%
  dplyr:: mutate(across(everything(), ~ ifelse(. <= sum(.) * (threshold/100), 0, .))) %>% otu_table(., taxa_are_rows = TRUE)

# remove all ASVs that are not present in any sample
ps_strain_filt <- ps_strain_filt %>%
  filter_taxa(function(x) sum(x > 0) > 0, TRUE)
```

#Rarefying
```{r}
# phyloseq%>%
ps_strain_filt%>%
  phyloseq_check_lib_size(data_color = "donor_name",
                          data_facet = NULL,
                          nreads_display = 3165,
                       first_n = nsamples(phyloseq)) -> lib

ps_strain_filt%>%
# phyloseq %>%
  rarefy_even_depth(rngseed = 123,
                    sample.size = 2900
                    # sample.size = 5000
                    ) -> phyloseq_rare
```

```{r}
# threshold=0.25
# 
# phyloseq_filt<-phyloseq
# 
# # filter per sample to remove all ASV lower in abundance than threshold (%)
# otu_table(phyloseq_filt) <- otu_table(phyloseq_filt) %>%
#   as.data.frame() %>%
#   dplyr:: mutate(across(everything(), ~ ifelse(. <= sum(.) * (threshold/100), 0, .))) %>% otu_table(., taxa_are_rows = TRUE)
# 
# # remove all ASVs that are not present in any sample
# phyloseq_filt <- phyloseq_filt %>%
#   filter_taxa(function(x) sum(x > 0) > 0, TRUE)
```

```{r}
# phyloseq_filt%>%
#   subset_samples(ox_nr %in% "MOCK")%>%
#   otu_table
#   # tax_table()
# 
# 
# phyloseq_filt%>%
#   subset_samples(ox_nr %in% "MOCK")%>%
#   microViz::comp_barplot(
#     tax_level = "Genus",
#     label = "ox_nr",
#     n_taxa =30,
#     bar_width = 0.9,
#     sample_order = "default",
#     tax_transform_for_plot = "compositional") +
#     ylab("Proportion") + xlab( "")-> p_hist
# p_hist
```




#A) Alpha diversity
#Alpha: From feces to cultures 
```{r}
###Feces to culture
phyloseq_rare%>% 
     subset_samples(Sample_id_compete %in% c("feces_dil_1", "feces") | stress %in% "control")%>%
  phyloseq_alphas(phylo = TRUE) -> alphas

unique(alphas$time)

alphas$time<-factor(alphas$time, levels=c("feces", "feces_dil", "pre-stress"))

aggregate(alphas$observed, by=list(alphas$time), FUN=median)

alphas%>%
  ggplot(aes(x=time, y=observed))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), strip.text.x = element_blank(), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot(aes(group=time), size=1)+
  geom_point(aes(colour=donor_name), size=3)+
  ggtitle("Alpha div. in feces & culures")

ggsave(filename = "Alpha_feces to culture.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output",
       width = 17,
       height = 17,
       units = c("cm"))

```
#Alpha: Upon H2O2 stress
```{r}
#H2O2
###Line plot########################################################################################
phyloseq_rare%>% 
     subset_samples(stress %in% c("H2O2", "control"))%>%
  phyloseq_alphas(phylo = TRUE) -> alphas

###ad control value to all stress-level
alphas%>%
  subset(stress %in% "control")->low
low$stress_level <- "low"
alphas%>%
  subset(stress %in% "control")->median
median$stress_level <- "median"
alphas%>%
  subset(stress %in% "control")->high
high$stress_level <- "high"
rbind(alphas, low, median, high)->alphas
#####

alphas$time<-factor(alphas$time, levels=c("pre-stress", "stress", "post_stress_1", "post_stress_2"))
alphas$stress_level<-factor(alphas$stress_level, levels=c("control", "low", "median", "high"))


alphas%>%
  ggplot(aes(x=time, y=observed))+
 theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_line(aes(colour=donor_name, group=donor_name), size=1)+
  facet_grid(cols=vars(stress_level))+
  ggtitle("Alpha diversity")

ggsave(filename = "alpha_h2o2.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/H2O2/alpha/output",
       width = 20,
       height = 30,
       units = c("cm"))
  # library(rstatix)

# library(ggpubr)
alphas%>%
   subset(!time %in% c("pre-stress"))%>%
  mutate(stress_level = factor(stress_level, levels=c("control", "low", "median", "high")),
         time = factor(time, levels=c( "stress", "post_stress_1", "post_stress_2"))) %>%
  group_by(time)%>%
  wilcox_test(data= .,
  formula = diversity_shannon ~ stress_level, ref.group = "control" 
  )%>%
  add_significance()%>%
  subset(!p.adj.signif %in% "ns")%>%
  add_y_position()->stat_test


alphas%>%
  subset(!time %in% "pre-stress")%>%
  mutate(stress_level = factor(stress_level, levels=c("control", "low", "median", "high")),
         time = factor(time, levels=c( "stress", "post_stress_1", "post_stress_2"))) %>%
  ggplot(aes(x=stress_level, y=diversity_shannon))+
  scale_fill_manual(values=c("steelblue4", "steelblue3",  "coral2", "coral3"))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=15, angle = 90, vjust= 0.5, hjust=1),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot(aes(fill=stress_level), outlier.shape = NA, position = position_dodge2(preserve = "single"))+
  geom_point(aes(colour=donor_name), position = position_jitterdodge(0.05))+
  ggtitle("Alpha diversity")+
  ylab("Shannon-Index")+
  labs(colour="Donor", fill="Stress level")+
  facet_grid(cols=vars(time),scales= "free", labeller=facet_labeller) +
  stat_pvalue_manual(stat_test, label = "p.adj.signif", hide.ns = T)
  
   # force_panelsizes(rows = unit(8, "cm"),
   #                 cols = unit(11, "cm"))
  
  # x<-paste(stress_level_cond[i])

ggsave(filename = paste( "alpha_h2o2.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/H2O2/alpha",
       width = 25,
       height = 10,
       units = c("cm"))

```
```{r}
stress_level_cond<-c("low"  ,  "median" , "high")
for (i in 1: length(stress_level_cond)){

alphas %>%
    subset(stress_level %in% c("control", stress_level_cond[i]))%>%
  group_by(time) %>%
  wilcox_test(data= .,
  formula = diversity_shannon ~ stress_level ,
  )%>%
  add_significance()->wil
  print(stress_level_cond[i])
  print(wil[, c("time", "p.signif")])
}
```
#Alpha: upon oxygen stress
```{r}
#O2: aerobic
phyloseq_rare%>% 
     subset_samples( stress %in% "control" | (stress %in% "O2" ))%>%
  phyloseq_alphas(phylo = TRUE) -> alphas

###ad control value to all stress-level (anaerobe)
alphas%>%
  subset(stress %in% "control")->low
low$stress_level <- "low"

alphas%>%
  subset(stress %in% "control")->median
median$stress_level <- "median"

alphas%>%
  subset(stress %in% "control")->high
high$stress_level <- "high"

alphas%>%
  subset(stress %in% "control")->max
max$stress_level <- "max"
###ad control value to all stress-level (aerobe)
alphas%>%
  subset(stress %in% "control")->control
aerobe<-rbind(control, low, median, high, max)
aerobe$incubation<-"aerobe"
#####

alphas <-rbind(alphas, aerobe, low, control, median, high, max)

alphas$time<-factor(alphas$time, levels=c("pre-stress", "stress", "post_stress_1", "post_stress_2"))

alphas$stress_level<-factor(alphas$stress_level, levels=c("control", "low", "median", "high", "max"))

alphas%>%
  ggplot(aes(x=time, y=observed))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_line(aes(colour=donor_name, group=donor_name), size=1)+
  facet_grid(cols=vars(stress_level, incubation))+
  ggtitle("Alpha div.")+
  ylim(80, 200)

ggsave(filename = "alpha_o2.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2/alpha",
       width = 40,
       height = 14,
       units = c("cm"))

stress_level_cond<-c("control", "low"  ,  "median" , "high", "max")

# for (i in 1: length(stress_level_cond)){

alphas$incubation<-factor(alphas$incubation, levels=c("anaerobe", "aerobe"))

names<-list("stress"= "Stress", 
            "post_stress_1"= "Post 1", 
            "post_stress_2"= "Post 2")

facet_labeller <- function(variable,value){
  return(names[value])
}


alphas%>%
  subset(!time %in% c("pre-stress"))%>%
  mutate(stress_level = factor(stress_level, levels=c("control", "low", "median", "high", "max")),
         time = factor(time, levels=c( "stress", "post_stress_1", "post_stress_2"))) %>%
  group_by(time, stress_level)%>%
  wilcox_test(data= .,
  formula = diversity_shannon ~ incubation
  )%>%
  add_significance()%>%
  subset(!p.signif %in% "ns")%>%
  add_y_position()->stat_test


alphas%>%
  subset(!time %in% c("pre-stress"))%>%
  mutate(stress_level = factor(stress_level, levels=c("control", "low", "median", "high", "max")),
         time = factor(time, levels=c( "stress", "post_stress_1", "post_stress_2"))) %>%
  ggplot(aes(x=stress_level, y=diversity_shannon))+
  scale_alpha_manual(values=c(1,0.5), name="Incubation", labels=c("Control", "Stress"))+
  scale_fill_manual(values=c("steelblue4","steelblue3" ,"coral2"  , "coral3", "coral4"), labels=c("control", "low", "median", "high","max"))+
 theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=15, angle = 90, vjust= 0.5, hjust=1),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot(aes(fill=stress_level, alpha=incubation), outlier.shape = NA, position = position_dodge2(preserve = "single"))+
  geom_point(aes(colour=donor_name, group=incubation), position = position_jitterdodge(0.1))+
  ggtitle("Alpha diversity")+
  # scale_x_discrete(labels=c("minimal", "low", "median", "high", "max"))+
  ylab("Shannon-Index")+
  labs(colour="Donor", fill="Stress level")+
   # force_panelsizes(rows = unit(c(1,2,2), "cm"),
   #                 cols = unit(11, "cm"))+
  facet_grid(cols=vars(time), labeller=facet_labeller)+
  guides(alpha = guide_legend(override.aes = list(fill = "darkgrey"))) +
  ylim(2, 4)
  # stat_pvalue_manual(stat_test, label = "p.signif", hide.ns = T)
  
  x<-paste(stress_level_cond[i])

ggsave(filename = paste(x, "O2_alpha_o2_shannon.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2/alpha",
       width = 25,
       height = 20,
       units = c("cm"))
# }
```
```{r}
alphas%>%
  subset(!time %in% c("pre-stress"))%>%
  group_by(time, stress_level) %>%
  wilcox_test(data= .,
  formula = diversity_shannon ~ incubation ,
  )%>%
  add_significance()->wil
```

#B) Beta diversity
#Calculations of distances: feces vs. cultures
```{r}
# library(dplyr)


phyloseq_filt %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1"))%>%
  subset_samples(!donor_name %in% NA)-> sub
sub%>%
  phyloseq::distance(method = "bray") -> bc
sub %>%
  ordinate(method = "PCoA",
           distance = bc) -> ord
sub %>% 
  phyloseq_distance_boxplot(p = ., 
                            dist = bc, 
                            d = "ox_nr") -> out # column in metadata for comparaisons

setNames(as.data.frame(out$matrix),c("sample_name", "sample_name_comp", "value", "condition_comp", "comparison")) -> distances

distances%>%
  subset(comparison %in% c("feces"))-> distances

joined<-left_join(distances, sample.data.frame(sub)[,c(1,7:12)])

joined%>%
  mutate(sample_name_comp = recode(sample_name_comp, "M-01" = 'D1',
                                   "M-02" = 'D2',
                                   "M-03" = 'D3',
                                   "M-04" = 'D4',
                                   "M-05" = 'D5',
                                   "M-06" = 'D6',
                                   "M-07" = 'D7',
                                   "M-08" = 'D8',))->joined

for (i in 1:nrow(joined)){
  if (joined[i,c("donor_name")] == joined[i,c("sample_name_comp")]){joined[i,c("match")]= "true"}
}

joined%>%
  subset(match %in% "true")->match

# match$condition_comp<-factor(match$condition_comp, levels=c("control","protein_YCFA"))
```

#Plots
```{r}

###feces to cultures
match%>%
  subset(stress %in% "control")->sub_dist

aggregate(sub_dist$value, by=list(sub_dist$time), FUN=mean)

sub_dist$time<-factor(sub_dist$time, levels=c("pre-stress"))
sub_dist$stress_level<-factor(sub_dist$stress_level, levels=c("control", "low", "median", "high"))
sub_dist%>%
  ggplot(aes(x=time, y=value))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20),  panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot()+ geom_point(aes(colour=donor_name), size=3)+
  ggtitle("Beta dist.: feces vs. culures")+
  ylim(0,1)

ggsave(filename = "Beta_dist_culture_feces.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output",
       width = 14,
       height = 17,
       units = c("cm"))
```


#Calculations of distances: control culture vs. subsequent passages
```{r}
phyloseq_rare %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1", "feces"))%>%
  subset_samples(!donor_name %in% NA)-> sub

sub %>%
  microbiome::transform("clr") -> ps_transformed

ps_transformed%>%
  phyloseq::distance(method = "euclidean") -> bc

ps_transformed %>%
  ordinate(method = "PCoA",
           distance = bc) -> ord
ps_transformed %>% 
  phyloseq_distance_boxplot(p = ., 
                            dist = bc, 
                            d = "time") -> out # column in metadata for comparaisons

setNames(as.data.frame(out$matrix),c("sample_name", "sample_name_comp", "value", "condition_comp", "comparison")) -> distances

distances%>%
  subset(comparison %in% c("pre-stress"))-> distances

joined<-left_join(distances, sample.data.frame(sub)[,c(1,7:12)])

joined%>%
  mutate(sample_name_comp = recode(sample_name_comp, "M-09" = 'D1',
                                   "M-10" = 'D2',
                                   "M-11" = 'D3',
                                   "M-12" = 'D4',
                                   "M-13" = 'D5',
                                   "M-14" = 'D6',
                                   "M-15" = 'D7',
                                   "M-16" = 'D8',))->joined

for (i in 1:nrow(joined)){
  if (joined[i,c("donor_name")] == joined[i,c("sample_name_comp")]){joined[i,c("match")]= "true"}
}

joined%>%
  subset(match %in% "true")->match

# match$condition_comp<-factor(match$condition_comp, levels=c("control","protein_YCFA"))
```

#H2O2
```{r}
match%>%
  subset(stress %in% "H2O2" )%>%
  ggplot(aes(x=time, y=value))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20),  panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_line(aes(colour=stress_level, group=stress_level), size=1)+
  facet_grid( cols=vars(donor_name))+
  geom_point(aes(colour=stress_level, group=stress_level))+
  ggtitle("Beta dist.: pre-stress vs. culures:H2O2")

ggsave(filename = "Beta_dist_H2O2.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/H2O2",
       width = 30,
       height = 17,
       units = c("cm"))

match$stress_level<-factor(match$stress_level, levels=c("control", "low", "median", "high"))

match%>%
  subset(stress %in% "H2O2" )%>%
  ggplot(aes(x=time, y=value))+
  scale_fill_manual(values=c("steelblue4", "steelblue3",  "coral2", "coral3"))+
 theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(size=20),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot(aes(fill=stress_level), outlier.shape = NA, position = position_dodge2(preserve = "single"))+
  geom_point(aes(colour=donor_name, group=stress_level), position = position_jitterdodge(0.05))+
  ggtitle("Bray-Curtis distances")+
  scale_x_discrete(labels=c("Stress", "Post 1", "Post 2"))+
  ylab("Distance")+
  labs(colour="Donor", fill="Stress level") 
  #  force_panelsizes(rows = unit(10, "cm"),
  #                  cols = unit(11, "cm"))

ggsave(filename = paste("beta_h2o2.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/H2O2",
       width = 20,
       height = 10,
       units = c("cm"))



#########################################################################################################
##Box plots
#########################################################################################################
stress_level_cond<-c("low"  ,  "median" , "high")
for (i in 1: length(stress_level_cond)){
match%>%
  subset(stress %in% "H2O2" )%>%
    subset(stress_level %in% c(stress_level_cond[i], "control"))%>%
  ggplot(aes(x=time, y=value))+
 theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot(aes(fill=stress_level))+
  geom_point(aes(colour=donor_name, group=stress_level), position = position_jitterdodge(0.1))+
  ggtitle("Alpha diversity")
  
  x<-paste(stress_level_cond[i])

ggsave(filename = paste(x, "beta_h2o2.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/H2O2",
       width = 20,
       height = 14,
       units = c("cm"))}
```

```{r}
time <- c("stress", "post_stress_1", "post_stress_2")
stress_level_cond <-c("low", "median", "high")

for (i in 1:length(time)){
  for (j in 1:length(stress_level_cond)){
  phyloseq_rare %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1", "feces"))%>%
  subset_samples(stress %in% "H2O2") %>%
    subset_samples(time %in% time[i]) %>%
    subset_samples(stress_level %in% c("control", stress_level_cond[j]))->sub
  
  sub%>%
  phyloseq::distance(method = "bray") -> bc
    
    vegan::adonis2(bc ~ get_variable(sub,"stress_level") + get_variable(sub,"donor_name"), p.adjust.methods= "BH")->adonis
    
    
    
  print(c(time[i], stress_level_cond[j]) )
  print(adonis)
  }}

```
#O2
```{r}
match$time<-factor(match$time, levels=c("pre-stress", "stress", "post_stress_1", "post_stress_2"))
match$stress_level<-factor(match$stress_level, levels=c("control", "low", "median", "high", "max"))

match%>%
  subset(stress %in% "O2" )%>%
  ggplot(aes(x=time, y=value))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
   geom_line(aes(colour=stress_level, group=stress_level), size=1)+
  facet_grid( cols=vars(donor_name, incubation))+
  geom_point(aes(colour=stress_level, group=stress_level))+
  ggtitle("Beta dist.: pre-stress vs. culures:anaerobic controls")

ggsave(filename = "Beta_dist_O2_anaerobe.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2",
       width = 40,
       height = 17,
       units = c("cm"))

match%>%
  subset(stress %in% "O2" )%>%
  ggplot(aes(x=time, y=value))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
   geom_boxplot(aes(fill=incubation), size=1, outlier.shape = NA)+
  facet_grid(cols=vars(stress_level))+
  geom_point(aes(colour=donor_name, group=incubation), position = position_dodge(1), alpha=0.8, size=3)+
  ggtitle("Beta dist.: pre-stress vs. culures:anaerobic controls")

ggsave(filename = "Beta_dist_box.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2",
       width = 40,
       height = 17,
       units = c("cm"))

```
```{r}
time <- c("stress", "post_stress_1", "post_stress_2")
stress_level_cond <-c("low", "median", "high")

for (i in 1:length(time)){
  for (j in 1:length(stress_level_cond)){
  phyloseq_rare %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1", "feces"))%>%
  subset_samples(stress %in% "H2O2") %>%
    subset_samples(time %in% time[i]) %>%
    subset_samples(stress_level %in% c("control", stress_level_cond[j]))->sub
  
  sub%>%
  phyloseq::distance(method = "bray") -> bc
    
    vegan::adonis2(bc ~ get_variable(sub,"stress_level") + get_variable(sub,"donor_name"), p.adjust.methods= "BH")->adonis
    
    
    
  print(c(time[i], stress_level_cond[j]) )
  print(adonis)
  }}

```

#Distance between control conditions: H2O2
```{r}

phyloseq_rare %>%
  # subset_samples(time %in% "stress")%>%
  subset_samples(stress %in% c("H2O2"))-> sub

sub %>%
  microbiome::transform("clr") -> ps_transformed

ps_transformed%>%
  phyloseq::distance(method = "euclidean") -> bc

ps_transformed %>%
  ordinate(method = "PCoA",
           distance = bc) -> ord
ps_transformed %>% 
  phyloseq_distance_boxplot(p = ., 
                            dist = bc, 
                            d = "stress_level") -> out# column in metadata for comparaisons

setNames(as.data.frame(out$matrix),c("sample_name", "sample_name_comp", "value", "condition_comp", "comparison")) -> distances

distances%>%
  subset(comparison %in% c("control"))-> distances

joined<-left_join(distances, sample.data.frame(sub)[,c(1,7:12)])

sample_name<-setNames(sample.data.frame(sub)[,c("sample_name", "donor_name", "time")], c("sample_name_comp", "donor_comp", "time_comp"))


joined_2<-left_join(joined, sample_name)
 

for (i in 1:nrow(joined_2)){
  if (joined_2[i,c("donor_name")] == joined_2[i,c("donor_comp")] & joined_2[i,c("time")] == joined_2[i,c("time_comp")]){joined_2[i,c("match")]= "true"}
}

joined_2%>%
  subset(match == c("true"))-> match_h2o2
```

```{r}
match_h2o2$stress_level<-factor(match_h2o2$stress_level, levels=c("low", "median", "high"))
match_h2o2$time<-factor(match_h2o2$time, levels=c("stress", "post_stress_1", "post_stress_2"))

match_h2o2%>%
  ggplot(aes(x=time, y=value))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=20, angle=90),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
   geom_boxplot(aes(fill=stress_level), size=1, outlier.shape = NA)+
  geom_point(aes(colour=donor_name, group=stress_level), position = position_dodge(0.8), alpha=0.8, size=3)+
  ggtitle("Beta dist.: control vs. stress")+
  ylim(0,1)

ggsave(filename = "Beta_dist_box.jpeg",
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/H2O2",
       width = 17,
       height = 17,
       units = c("cm"))

names<-list("stress"= "Stress", 
            "post_stress_1"= "Post 1", 
            "post_stress_2"= "Post 2")

facet_labeller <- function(variable,value){
  return(names[value])
}


match_h2o2%>%
 subset(stress %in% "H2O2" )%>%
  ggplot(aes(x=time, y=value))+
  scale_fill_manual(values=c("steelblue3",  "coral2", "coral3"))+
 theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
  geom_boxplot(aes(fill=stress_level), outlier.shape = NA, position = position_dodge2(preserve = "single"))+
  geom_point(aes(colour=donor_name, group=stress_level), position = position_jitterdodge(0.05))+
  ggtitle("Beta distances to control")+
  scale_x_discrete(labels=c("Stress", "Post 1", "Post 2"))+
  ylab("Aitchison distance")+
  labs(colour="Donor", fill="Stress level") +
  facet_grid(cols=vars(time), scale="free", labeller=facet_labeller)
   # force_panelsizes(rows = unit(8, "cm"),
   #                 cols = unit(11, "cm"))

ggsave(filename = paste("beta_h2o2.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/H2O2",
       width = 24.8,
       height = 10,
       units = c("cm"))
```


#Distance between control conditions: O2
```{r}
phyloseq_rare %>%
  # subset_samples(time %in% "stress")%>%
  subset_samples(stress %in% c("O2"))-> sub

sub %>%
  microbiome::transform("clr") -> ps_transformed

ps_transformed%>%
  phyloseq::distance(method = "euclidean") -> bc

ps_transformed %>%
  ordinate(method = "PCoA",
           distance = bc) -> ord
ps_transformed %>% 
  phyloseq_distance_boxplot(p = ., 
                            dist = bc, 
                            d = "incubation") -> out -> out # column in metadata for comparaisons

setNames(as.data.frame(out$matrix),c("sample_name", "sample_name_comp", "value", "condition_comp", "comparison")) -> distances

distances%>%
  subset(comparison %in% c("anaerobe"))-> distances

joined<-left_join(distances, sample.data.frame(sub)[,c(1,7:12)])

sample_name<-setNames(sample.data.frame(sub)[,c("sample_name", "incubation", "donor_name", "time", "stress_level")], c("sample_name_comp", "incubation_comp","donor_comp", "time_comp", "stress_level_comp"))


joined_2<-left_join(joined, sample_name)
 

for (i in 1:nrow(joined_2)){
  if ((joined_2[i,c("condition_comp")] != joined_2[i,c("incubation_comp")]) & 
      (joined_2[i,c("donor_name")] == joined_2[i,c("donor_comp")]) & 
      (joined_2[i,c("time")] == joined_2[i,c("time_comp")]) &
      (joined_2[i,c("stress_level")] == joined_2[i,c("stress_level_comp")])) {joined_2[i,c("match")]= "true"}
}

joined_2%>%
  subset(match == c("true"))-> match_o2
```
```{r}
match_o2$stress_level<-factor(match_o2$stress_level, levels=c("control","low", "median", "high", "max"))
match_o2$time<-factor(match_o2$time, levels=c("stress", "post_stress_1", "post_stress_2"))

names<-list("stress"= "Stress", 
            "post_stress_1"= "Post 1", 
            "post_stress_2"= "Post 2")

facet_labeller <- function(variable,value){
  return(names[value])
}

match_o2%>%
  # subset(stress_level %in% c("control", "median", "max"))%>%
  ggplot(aes(x=time, y=value))+
  theme(strip.text = element_text(size  = 20),
          axis.text.y= element_text(size = 20), 
        axis.title.y = element_text(size=20), 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        legend.text = element_text(size = 20, vjust=1, hjust=0),
        legend.title = element_text(size= 20),
        plot.title = element_text(size=20), panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA), legend.text.align = 0)+
   geom_boxplot(aes(fill=stress_level), size=1, outlier.shape = NA)+
  geom_jitter(aes(colour=donor_name, group=stress_level), position = position_jitterdodge(0.05))+
  ggtitle("Beta distance to control")+
   # scale_fill_manual(values=c("steelblue4","coral2"  , "coral4"), labels=c("minimal",  "median","max"))+
  # ylim(10,25)+
  ylab("Aitchison distance")+
  labs(colour="Donor", fill="Stress level") +
  facet_grid(cols=vars(time), scale="free", labeller=facet_labeller)
  


ggsave(filename = paste(x, "O2_alpha_o2.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/O2/beta",
       width = 24.8,
       height = 10,
       units = c("cm"))


```
```{r}
time <- c("stress", "post_stress_1", "post_stress_2")
stress_level_cond <-c("control", "low", "median", "high", "max")

for (i in 1:length(time)){
  for (j in 1:length(stress_level_cond)){
  phyloseq_rare %>%
  subset_samples(!Sample_id_compete %in% c("feces_dil_1", "feces"))%>%
  subset_samples(stress %in% "
                 O2") %>%
    subset_samples(time %in% time[i]) %>%
    subset_samples(stress_level %in% c( stress_level_cond[j]))->sub
  
  sub%>%
  phyloseq::distance(method = "bray") -> bc
    
    vegan::adonis2(bc ~ get_variable(sub,"incubation") + get_variable(sub,"donor_name"), p.adjust.methods= "BH")->adonis
    
    
    
  print(c(time[i], stress_level_cond[j]) )
  print(adonis)
  }}

```


# PCOa
```{r}
phyloseq_rare %>%
  subset_samples(time %in% "stress")%>%
  subset_samples(stress_level %in% c("max"))%>%
  subset_samples(stress %in% c("O2"))-> sub

# library(plyr)
print(media[i])
  dist = "bray"
  ord_meths = c("PCoA")


  plist = llply(as.list(ord_meths), function(i, sub, dist){
          ordi = ordinate(sub, method=i, distance=dist)
          plot_ordination(physeq = sub, 
                          ordination = ordi,
                          color = "donor_name", 
                          shape = "stress",
                          title = "PCoA Bray-Curtis", 
                          label= "time")},
          sub, 
          dist)


  names(plist) <- ord_meths

  pdataframe = ldply(plist, function(x){
      df = x$data[, 1:2]
      colnames(df) = c("Axis_1", "Axis_2")
      return(cbind(df, x$data))})


  
  names(pdataframe)[1] = "method"


  pdataframe%>%
      ggplot(aes(Axis_1, Axis_2))+ 
      # scale_color_manual(values=c('darkgoldenrod1', "cyan4"))+
      geom_point(aes(shape=incubation, colour=donor_name), size=4, stroke=1.5)+
      ggtitle(title)+
      theme(axis.text.y= element_text(size = 20), 
          axis.title.y = element_text(size=20), 
          axis.title.x = element_text(size=20),
          axis.text.x = element_text(size=20),
          legend.text = element_text(size = 20),
          legend.title = element_text(size= 20),
          plot.title = element_text(size=20), 
          legend.text.align = 0, 
        panel.background = element_rect(fill="white"),
        panel.border=element_rect(fill=NA))
  
  
  show(p)
```

