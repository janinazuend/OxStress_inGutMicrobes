---
title: "20221214_MIC_MBC_oxygen"
output: html_document
date: '2022-12-14'
---

```{r setup, echo =FALSE}
.libPaths('C:\\Users\\zuendj\\Documents\\R4Libs')
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/zuendj/Desktop/03_data R/oxidative stress", cho = TRUE, warning = FALSE, message = FALSE)

# Install Packages:
# install.packages("rlang")
# install.packages("tidyr")
# install.packages("ggbreak")

# unload("mia")
library(tidyverse)
library(ggplot2)
library(tidyr)
# install.packages("devtools")
# devtools::install_github("slowkow/ggrepel")
library(ggrepel)
library(ggbreak)
library(openxlsx)
```

##Load the Data
```{r}
bacteria_MIC <- list.files(path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MIC")
bacteria_MBC <- list.files(path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MBC")
#bacteria<- bacteria[-(27:29)]


options(scipen=999)


#define empty matrices, no values added so far 
MIC_average<- matrix(0, length(bacteria_MIC), 13)
MBC_average<- matrix(0, length(bacteria_MBC), 13)

blank_corrected_MIC<- matrix(0, length(bacteria_MIC)*6, 13)
blank_corrected_MBC<- matrix(0, length(bacteria_MBC)*6, 13)

#define MIC and MBC value for each species 
#MIC, fill values into MIC, here OD corrected values, but not corrected with agar 
row = 0

setwd("C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MIC")
for (l in 1:length(bacteria_MIC)) {
  #generate MICwide format
  MICwide = read.csv(bacteria_MIC[l], sep=";", header=F, check.names =F)
  #look for A indicating the area in the excel file with the data
  for (r in 1:40) {
    if (MICwide[r,1]=="A") {
      zeile = r
    }
  }
#########################################
  # print(bacteria_MIC[l])
  row = (l-1)*6
  # print(row)

  #generate blank corrected values
  for(i in 1:12) {
    #x indicated the colum->'A' is in column 1 and the data next to it from column 2 on
    x = 1+i
    zeile_end = zeile+6
    d = as.numeric(unlist(data.frame(MICwide[zeile:zeile_end, x])))
    for(j in 1:6){
      y = d[j] - d[7]
      blank_corrected_MIC[row+j, i] = y
    }
  }
  
  
  
  #########################################
  #generate averages 
  for(i in 1:12) {
    r1= row+1
    r2= row+6
    MIC_average[l, i] = as.numeric(mean(blank_corrected_MIC[r1:r2, i],  na.rm=TRUE))
  }
} 




#MBC
setwd( "C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MBC")
row = 0
for (l in 1:length(bacteria_MBC)) {
  #generate MICwide format
  MBCwide = read.csv(bacteria_MBC[l], sep=";", header=F, check.names =F)
  #look for A indicating the area in the excel file with the data
  for (r in 1:40) {
    if (MBCwide[r,1]=="A") {
      zeile = r
    }
  }
  #########################################
  # print(bacteria_MBC[l])
  row = (l-1)*6
  # print(row)
  
  #generate blank corrected values
  for(i in 1:12) {
    #x indicated the colum->'A' is in column 1 and the data next to it from column 2 on
    x = 1+i
    zeile_end = zeile+6
    d = as.numeric(unlist(data.frame(MBCwide[zeile:zeile_end, x])))
    for(j in 1:6){
      y = d[j] - d[7]
      blank_corrected_MBC[row+j, i] = y
    }
  }
  
  #########################################
  #generate averages 
  for(i in 1:12) {
    r1= row+1
    r2= row+6
    MBC_average[l, i] = as.numeric(mean(blank_corrected_MBC[r1:r2, i],  na.rm=TRUE))
  }
} 

```


## Get the MIC for individual repleciates
```{r}
#########################################
#define row names for the blank corrected 
bacteria <- strsplit(bacteria_MBC, ".csv")
bacteria <- as.character(bacteria)

row_names_mbc<-matrix(0,length(bacteria)*6,1)
position = 0
for (i in 1:length(bacteria)) {
  for (j in 1:6) {
    row_names_mbc[position+j,1] = bacteria[i]
  }
  position = position+6
}


bacteria <- strsplit(bacteria_MIC, ".csv")
bacteria <- as.character(bacteria)

row_names_mic<-matrix(0,length(bacteria)*6,1)
position = 0
for (i in 1:length(bacteria)) {
  for (j in 1:6) {
    row_names_mic[position+j,1] = bacteria[i]
  }
  position = position+6
}


MIC_replicates_h2o2 <-data.frame(row_names_mic, blank_corrected_MIC)

colnames(MIC_replicates_h2o2)<-list("bacteria", 0, 0.06, 0.21, 0.66, 2.21, 6.77, 21.66, 69.31, 221.8, 709.7, 2271.25, 7268, 8000)

MBC_replicates_h2o2 <-data.frame(row_names_mbc, blank_corrected_MBC)
colnames(MBC_replicates_h2o2)<-list("bacteria",0, 0.06, 0.21, 0.66, 2.21, 6.77, 21.66, 69.31, 221.8, 709.7, 2271.25, 7268, 8000)
```

```{r}
write.xlsx(MBC_replicates_h2o2, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MBC_H2O2_replicates.xlsx")
write.xlsx(MIC_replicates_h2o2, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_H2O2_replicates.xlsx")


# 
# MIC_replicates_h2o2[c(24, 161, 81),c("7268")]<-0
# MIC_replicates_h2o2[c(81),c("2271.25")]<-0
# 
# MBC_replicates_h2o2[c(69, 161, 162),c("2271.25")]<-0
# MBC_replicates_h2o2[c(171),c("7268")]<-0




MBC_mod<-read.xlsx("C:/Users/zuendj/Desktop/03_data R/oxidative stress/MBC_H2O2_replicates_mod.xlsx")
# MBC_mod[is.na(MBC_mod)] <- 0
MIC_mod<-read.xlsx("C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_H2O2_replicates_mod.xlsx")
# MIC_mod[is.na(MIC_mod)] <- 0
```

## Define the MIC/MBC values

```{r}
#get long format
average_long<-gather(MIC_mod, condition, OD, "1":"13", factor_key = T )
#take averages of the technical replicate
average_long_tec<-set_names(aggregate(average_long$OD, list(average_long$bacteria, average_long$replicate, average_long$condition), FUN=mean, na.rm=TRUE), colnames(average_long))
#get average per condition -> to get max
average<-set_names(aggregate(average_long_tec$OD, list(average_long_tec$bacteria, average_long_tec$condition), FUN=mean, na.rm=TRUE), c("bacteria", "condition" ,"average"))
# find max
max_mic<-set_names(aggregate(average$average, by = list(average$bacteria), max, na.rm=TRUE), c("bacteria", "max"))

MIC_replicates_wide<-pivot_wider(average_long_tec, names_from = condition , values_from = OD)


#same for MBC
average_long<-gather(MBC_mod, condition, OD, "1":"13", factor_key = T )
average_long_tec<-set_names(aggregate(average_long$OD, list(average_long$bacteria, average_long$replicate, average_long$condition), FUN=mean, na.rm=TRUE), colnames(average_long))
average<-aggregate(average_long_tec$OD, list(average_long_tec$bacteria, average_long_tec$condition), FUN=mean, na.rm=TRUE)
names(average)<-c("bacteria", "condition" ,"average")
max_mbc<-set_names(aggregate(average$average, by = list(average$bacteria), max, na.rm=TRUE), c("bacteria", "max"))

MBC_replicates_wide<-pivot_wider(average_long_tec, names_from = condition , values_from = OD)

MIC_mod_av<-left_join(MIC_replicates_wide, max_mic)
MBC_mod_av<-left_join(MBC_replicates_wide, max_mbc)



MIC_vector <- vector()
for (i in 1:nrow(MIC_mod_av)) { #vertical 
  candidates <- vector()
     for(j in 3:14) {#horizontal 
       if (!is.na(MIC_mod_av[i,j]) & MIC_mod_av[i,j]/MIC_mod_av[i, "max"]>0.1 & MIC_mod_av[i,j]>0.0336) {#-> MIC_value_absolut)
         candidates <- append(candidates, colnames(MIC_mod_av)[j])
         candidates <-as.numeric(candidates)
         # print((MIC_replicates_h2o2)[j,1])
       }
     }
  MIC_vector <- append(MIC_vector, max(candidates))
}



MBC_vector <- vector()
for (i in 1:nrow(MBC_mod_av)) { #vertical 
  candidates <- vector()
  for(j in 3:14) {#horizontal 
    if (!is.na(MBC_mod_av[i,j]) & MBC_mod_av[i,j]/MBC_mod_av[i, "max"]>0.1 & MBC_mod_av[i,j]>0.0336) {#-> MIC_value_absolut)
      
      candidates <- append(candidates, colnames(MBC_mod_av)[j])
      candidates <-as.numeric(candidates)
    }
  }
  MBC_vector <- append(MBC_vector, max(candidates))
}


MIC_vector_full <- vector()
for (i in 1:nrow(MIC_mod_av)) { #vertical 
  candidates <- vector()
     for(j in 3:14) {#horizontal 
       if (!is.na(MIC_mod_av[i,j]) & MIC_mod_av[i,j]/MIC_mod_av[i, "max"]>0.5 & MIC_mod_av[i,j]>0.0336) {#-> MIC_value_absolut)
         candidates <- append(candidates, colnames(MIC_mod_av)[j])
         candidates <-as.numeric(candidates)
         # print((MIC_replicates_h2o2)[j,1])
       }
     }
  MIC_vector_full <- append(MIC_vector_full, max(candidates))
}


MBC_vector_full <- vector()
for (i in 1:nrow(MBC_mod_av)) { #vertical 
  candidates <- vector()
  for(j in 3:14) {#horizontal 
    if (!is.na(MBC_mod_av[i,j]) & MBC_mod_av[i,j]/MBC_mod_av[i, "max"]>0.5 & MBC_mod_av[i,j]>0.0336) {#-> MIC_value_absolut)
      
      candidates <- append(candidates, colnames(MBC_mod_av)[j])
      candidates <-as.numeric(candidates)
    }
  }
  MBC_vector_full <- append(MBC_vector_full, max(candidates))
}


```

```{r}
#assign MIC/MBC vectors to a data frame
df_final_replicates <- data.frame(bacteria = MIC_mod_av$bacteria, 
                                  replicate = MIC_mod_av$replicate,
                                  MIC = as.numeric(MIC_vector), 
                                  MBC = as.numeric(MBC_vector),
                                  MIC_75 = as.numeric(MIC_vector_full),
                                  MBC_75 = as.numeric(MBC_vector_full))


order<-aggregate(df_final_replicates$MBC, by=list(df_final_replicates$bacteria), mean, na.rm=T)
colnames(order) <-c("bacteria", "order")

df_final_replicates<-left_join(df_final_replicates, order)


df_long<-gather(df_final_replicates[,c("bacteria", "replicate", "MIC", "MBC", "order")], assay, value, "MIC":"MBC", factor_key = T)

df_long_75<-gather(df_final_replicates[,c("bacteria", "replicate", "MIC_75", "MBC_75", "order")], assay, value_75, "MIC_75":"MBC_75", factor_key = T)
names(df_long_75)[names(df_long_75) == "MIC_75"] <- "MIC"

df_long_75$assay <- recode_factor(df_long_75$assay, MIC_75 = "MIC", 
                                MBC_75 = "MBC")

df_long_both<-left_join(df_long, df_long_75)


```


## Go back to the heatplot with relative od values
```{r}
# MBC_rel<-MBC_mod_av
# MIC_rel<-MIC_mod_av
# 
# for (i in 1:nrow(MIC_rel)) { #vertical 
#   for(j in 3:14) {#horizontal 
#      MIC_rel[i,j] = MIC_rel[i,j]/MIC_rel[i, c("max")] 
#   }}
# 
# for (i in 1:nrow(MBC_rel)) { #vertical 
#   for(j in 3:14) {#horizontal 
#      MBC_rel[i,j] = MBC_rel[i,j]/MBC_rel[i, c("max")] 
#   }}
# 
# 
# MIC_rel_long<-gather(MIC_rel, condition, OD, "1":"12", factor_key = T)
# MIC_rel_long$assay<-c("MIC")
# MBC_rel_long<-gather(MBC_rel, condition, OD, "1":"12", factor_key = T)
# MBC_rel_long$assay<-c("MBC")
# 
# MBC_MIC_rel_long<-rbind(MIC_rel_long, MBC_rel_long)
# MBC_MIC_rel_long<-left_join(MBC_MIC_rel_long, df_long_both)


MBC_rel<-MBC_mod_av
MIC_rel<-MIC_mod_av

for (i in 1:nrow(MIC_rel)) { #vertical 
  for(j in 3:14) {#horizontal 
     MIC_rel[i,j] = MIC_rel[i,j]/MIC_rel[i, c("max")] 
  }}

for (i in 1:nrow(MBC_rel)) { #vertical 
  for(j in 3:14) {#horizontal 
     MBC_rel[i,j] = MBC_rel[i,j]/MBC_rel[i, c("max")] 
  }}


# MBC_relgrowth_value<-cbind(MBC_rel, df_final_replicates)
# MIC_relgrowth_value<-cbind(MIC_rel, df_final_replicates)


MIC_rel_long<-gather(MIC_rel, condition, OD, "1":"13", factor_key = T)
MIC_rel_long$assay<-c("MIC")
MBC_rel_long<-gather(MBC_rel, condition, OD, "1":"13", factor_key = T)
MBC_rel_long$assay<-c("MBC")

MBC_MIC_rel_long<-rbind(MIC_rel_long, MBC_rel_long)
MBC_MIC_rel_long<-left_join(MBC_MIC_rel_long, df_long_both)
```


```{r}
# MBC_MIC_rel_long$value[MBC_MIC_rel_long$value <0.1]<-0
# MBC_MIC_rel_long$condition<-as.numeric(MBC_MIC_rel_long$condition)
# 
# for (i in 1:nrow(MBC_MIC_rel_long)){
#   if (MBC_MIC_rel_long[i, c("condition")] == MBC_MIC_rel_long[i, c("value")]) { 
#     MBC_MIC_rel_long[i, c("label")] = MBC_MIC_rel_long[i, c("value")]}}
# 
# MBC_MIC_rel_long$label<-as.numeric(MBC_MIC_rel_long$label)

MBC_MIC_rel_long$OD[MBC_MIC_rel_long$OD <0.1]<-0
MBC_MIC_rel_long$condition<-as.numeric(paste(MBC_MIC_rel_long$condition))


for (i in 1:nrow(MBC_MIC_rel_long)){
  if ( MBC_MIC_rel_long[i, c("condition")] == MBC_MIC_rel_long[i, c("value")]) { 
    MBC_MIC_rel_long[i, c("label")] = MBC_MIC_rel_long[i, c("value")]}}

MBC_MIC_rel_long$label<-as.numeric(MBC_MIC_rel_long$label)

for (i in 1:nrow(MBC_MIC_rel_long)){
  if ( MBC_MIC_rel_long[i, c("condition")] == MBC_MIC_rel_long[i, c("value_75")]) { 
    MBC_MIC_rel_long[i, c("label_75")] = MBC_MIC_rel_long[i, c("value_75")]}}

MBC_MIC_rel_long$label_75<-as.numeric(MBC_MIC_rel_long$label_75)


MBC_MIC_rel_long_label<-gather(MBC_MIC_rel_long, label_type, label_value, "label":"label_75")
```


```{r}

MBC_MIC_rel_long_label$label_value<-MBC_MIC_rel_long_label$label_value+1

MBC_MIC_rel_long_label%>%
  subset(!bacteria %in% c("Subdoligranulum variable", "Anaerobutyricum hallii", "Marvinbryantia formatixigens", "Ruminococcus bromii"))%>%
  drop_na(OD)->hoi

hoi%>%
  mutate(bacteria = fct_reorder(bacteria, hoi$order))%>%
  ggplot(aes(x = condition, y = assay, fill = OD)) + 
  geom_raster() +
  scale_shape_manual(values = c(16, 1), labels=c("10%", "50%"))+
scale_color_manual(values=c("coral2", "darkseagreen"))+
  labs(x=expression(paste("Oxygenation")))+
  theme(text = element_text(size=15), 
        axis.text.x = element_text(angle = 90, vjust= 0.5, hjust=1),
        axis.title.y= element_blank(),
        axis.text.y=element_text(size=10),
        strip.text.y = element_text(angle = 0, face = "italic", hjust=0),
        strip.background = element_blank())+
  facet_grid(rows =vars(bacteria), scales = "free", space = "free")+
  geom_point(aes(x=label_value, color=assay, shape=label_type),  size=2.5, alpha=0.75, position=position_jitterdodge(jitter.width = 0.3, jitter.height = 0.1))+
  scale_x_continuous(labels=c("0 nM", 
                              "6.4 nM",  
                              "21 nM", 
                              "66 nM", 
                              expression("2.2"~mu*M), 
                              expression("6.8"~mu*M),  
                              expression("21"~mu*M),
                              expression("69"~mu*M),
                              expression("222"~mu*M),
                              expression("710"~mu*M),  
                              "2.3 mM", "7.3 mM" , ">tested"), 
                     breaks=c(1, 2, 3, 4, 5, 6, 7,  8 ,9 ,10, 11, 12, 13))+
  labs(fill = expression(relative~OD[600]), colour="", shape="Cut off value for growth")+
  ggtitle(expression(MIC~and~MBC~of~H[2]*O[2]))



ggsave(filename = "MIC_MBC_h2o2_groeth.jpeg", 
       path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/output", 
       width = 20,
       height = 30,
       units = c("cm"))

```
```{r}
h2o2<-set_names(aggregate(hoi$value, by=list(hoi$bacteria, hoi$assay), FUN=mean), c("bacteria", "assay", "value_H2O2"))
write.xlsx(h2o2, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_MBC_H2O2.xlsx")
```

