---
title: "20221214_MIC_MBC_oxygen"
output: html_document
date: '2022-12-14'
---

```{r setup, echo =FALSE}
.libPaths('C:\\Users\\zuendj\\Documents\\R4Libs')
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/zuendj/Desktop/03_data R/oxidative stress", cho = TRUE, warning = FALSE, message = FALSE)

# Install Packages:
# install.packages("rlang")
# install.packages("tidyr")
# install.packages("ggbreak")

# unload("mia")
library(tidyverse)
library(ggplot2)
library(tidyr)
# install.packages("devtools")
# devtools::install_github("slowkow/ggrepel")
library(ggrepel)
library(ggbreak)
library(openxlsx)
```

##Load the Data
```{r}
bacteria_MIC <- list.files(path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MIC")
bacteria_MBC <- list.files(path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MBC")
#bacteria<- bacteria[-(27:29)]


options(scipen=999)


#define empty matrices, no values added so far 
MIC_average<- matrix(0, length(bacteria_MIC), 13)
MBC_average<- matrix(0, length(bacteria_MBC), 13)

blank_corrected_MIC<- matrix(0, length(bacteria_MIC)*6, 13)
blank_corrected_MBC<- matrix(0, length(bacteria_MBC)*6, 13)

#define MIC and MBC value for each species 
#MIC, fill values into MIC, here OD corrected values, but not corrected with agar 
row = 0

setwd("C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MIC")
for (l in 1:length(bacteria_MIC)) {
  #generate MICwide format
  MICwide = read.csv(bacteria_MIC[l], sep=";", header=F, check.names =F)
  #look for A indicating the area in the excel file with the data
  for (r in 1:40) {
    if (MICwide[r,1]=="A") {
      zeile = r
    }
  }
#########################################
  # print(bacteria_MIC[l])
  row = (l-1)*6
  # print(row)

  #generate blank corrected values
  for(i in 1:12) {
    #x indicated the colum->'A' is in column 1 and the data next to it from column 2 on
    x = 1+i
    zeile_end = zeile+6
    d = as.numeric(unlist(data.frame(MICwide[zeile:zeile_end, x])))
    for(j in 1:6){
      y = d[j] - d[7]
      blank_corrected_MIC[row+j, i] = y
    }
  }
  
  
  
  #########################################
  #generate averages 
  for(i in 1:12) {
    r1= row+1
    r2= row+6
    MIC_average[l, i] = as.numeric(mean(blank_corrected_MIC[r1:r2, i],  na.rm=TRUE))
  }
} 




#MBC
setwd( "C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MBC")
row = 0
for (l in 1:length(bacteria_MBC)) {
  #generate MICwide format
  MBCwide = read.csv(bacteria_MBC[l], sep=";", header=F, check.names =F)
  #look for A indicating the area in the excel file with the data
  for (r in 1:40) {
    if (MBCwide[r,1]=="A") {
      zeile = r
    }
  }
  #########################################
  # print(bacteria_MBC[l])
  row = (l-1)*6
  # print(row)
  
  #generate blank corrected values
  for(i in 1:12) {
    #x indicated the colum->'A' is in column 1 and the data next to it from column 2 on
    x = 1+i
    zeile_end = zeile+6
    d = as.numeric(unlist(data.frame(MBCwide[zeile:zeile_end, x])))
    for(j in 1:6){
      y = d[j] - d[7]
      blank_corrected_MBC[row+j, i] = y
    }
  }
  
  #########################################
  #generate averages 
  for(i in 1:12) {
    r1= row+1
    r2= row+6
    MBC_average[l, i] = as.numeric(mean(blank_corrected_MBC[r1:r2, i],  na.rm=TRUE))
  }
} 

```


## Get the MIC for individual repleciates
```{r}
#########################################
#define row names for the blank corrected 
bacteria <- strsplit(bacteria_MBC, ".csv")
bacteria <- as.character(bacteria)

row_names_mbc<-matrix(0,length(bacteria)*6,1)
position = 0
for (i in 1:length(bacteria)) {
  for (j in 1:6) {
    row_names_mbc[position+j,1] = bacteria[i]
  }
  position = position+6
}


bacteria <- strsplit(bacteria_MIC, ".csv")
bacteria <- as.character(bacteria)

row_names_mic<-matrix(0,length(bacteria)*6,1)
position = 0
for (i in 1:length(bacteria)) {
  for (j in 1:6) {
    row_names_mic[position+j,1] = bacteria[i]
  }
  position = position+6
}


MIC_replicates_h2o2 <-data.frame(row_names_mic, blank_corrected_MIC)

colnames(MIC_replicates_h2o2)<-list("bacteria", 0, 0.06, 0.21, 0.66, 2.21, 6.77, 21.66, 69.31, 221.8, 709.7, 2271.25, 7268, 8000)

MBC_replicates_h2o2 <-data.frame(row_names_mbc, blank_corrected_MBC)
colnames(MBC_replicates_h2o2)<-list("bacteria",0, 0.06, 0.21, 0.66, 2.21, 6.77, 21.66, 69.31, 221.8, 709.7, 2271.25, 7268, 8000)
```

```{r}
write.xlsx(MBC_replicates_h2o2, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MBC_H2O2_replicates.xlsx")
write.xlsx(MIC_replicates_h2o2, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_H2O2_replicates.xlsx")


# 
# MIC_replicates_h2o2[c(24, 161, 81),c("7268")]<-0
# MIC_replicates_h2o2[c(81),c("2271.25")]<-0
# 
# MBC_replicates_h2o2[c(69, 161, 162),c("2271.25")]<-0
# MBC_replicates_h2o2[c(171),c("7268")]<-0




MBC_mod<-read.xlsx("C:/Users/zuendj/Desktop/03_data R/oxidative stress/MBC_H2O2_replicates_mod.xlsx")
# MBC_mod[is.na(MBC_mod)] <- 0
MIC_mod<-read.xlsx("C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_H2O2_replicates_mod.xlsx")
# MIC_mod[is.na(MIC_mod)] <- 0
```

## Define the MIC/MBC values

```{r}
average<-aggregate(MIC_mod$`1`, list(MIC_mod$bacteria), FUN=mean, na.rm = TRUE)
names(average)<-c("bacteria", "average")
MIC_mod_av<-left_join(MIC_mod, average)

average<-aggregate(MBC_mod$`1`, list(MBC_mod$bacteria), FUN=mean, na.rm = TRUE)
names(average)<-c("bacteria", "average")
MBC_mod_av<-left_join(MBC_mod, average)

MIC_mod_av[is.na(MIC_mod_av)] <- 0
MBC_mod_av[is.na(MBC_mod_av)] <- 0


MIC_vector <- vector()
for (i in 1:nrow(MIC_mod_av)) { #vertical 
  candidates <- vector()
     for(j in 2:13) {#horizontal 
       if (MIC_mod_av[i,j]/MIC_mod_av[i, 2]>0.1 & MIC_mod_av[i,j]>0.0336) {#-> MIC_value_absolut)
         candidates <- append(candidates, colnames(MIC_mod_av)[j])
         candidates <-as.numeric(candidates)
         # print((MIC_replicates_h2o2)[j,1])
       }
     }
  MIC_vector <- append(MIC_vector, max(candidates))
}


MBC_vector <- vector()
for (i in 1:nrow(MBC_mod_av)) { #vertical 
  candidates <- vector()
  for(j in 2:13) {#horizontal 
    if (MBC_mod_av[i,j]/MBC_mod_av[i, 2]>0.1 & MBC_mod_av[i,j]>0.0336) {#-> MIC_value_absolut)
      
      candidates <- append(candidates, colnames(MBC_mod_av)[j])
      candidates <-as.numeric(candidates)
    }
  }
  MBC_vector <- append(MBC_vector, max(candidates))
}

MIC_mod_av[91,]

MIC_vector_full <- vector()
for (i in 1:nrow(MIC_mod_av)) { #vertical 
  candidates <- vector()
  print(i)
  for(j in 2:13) {#horizontal 
    if (MIC_mod_av[i,j]/MIC_mod_av[i, 2]>0.5) {#-> MIC_value_absolut)
      candidates <- append(candidates, colnames(MIC_mod_av)[j])
      candidates <-as.numeric(candidates)
    }
  }
  MIC_vector_full <- append(MIC_vector_full, max(candidates))
}



MBC_vector_full <- vector()
for (i in 1:nrow(MBC_mod_av)) { #vertical 
  candidates <- vector()
  for(j in 2:13) {#horizontal 
    if (MBC_mod_av[i,j]/MBC_mod_av[i, 2]>0.5) {#-> MIC_value_absolut)
      
      candidates <- append(candidates, colnames(MBC_mod_av)[j])
      candidates <-as.numeric(candidates)
    }
  }
  MBC_vector_full <- append(MBC_vector_full, max(candidates))
}


```

```{r}
#assign MIC/MBC vectors to a data frame
final_replicates <- matrix(0, length(row_names_mbc), 5)
final_replicates[, 1] <- row_names_mbc
final_replicates[, 2] <- as.numeric(MIC_vector)
final_replicates[, 3] <- as.numeric(MBC_vector)
final_replicates[,4] <-as.numeric(MIC_vector_full)
final_replicates[,5] <-as.numeric(MBC_vector_full)


#convert matrix into a data frame
df_final_replicates=as.data.frame(final_replicates)
df_final_replicates[, 2:5]<-lapply(df_final_replicates[,2:5], as.numeric)



#naming columns of the dataframe_final
col_names <- list("bacteria", "MIC_10","MBC_10","MIC_75", "MBC_75")
colnames(df_final_replicates) <-col_names


order<-aggregate(df_final_replicates$MBC_10, by=list(df_final_replicates$bacteria), mean)
colnames(order) <-c("bacteria", "order")

df_final_replicates<-left_join(df_final_replicates, order)


df_long<-gather(df_final_replicates, condition, value, "MIC_10":"MBC_75", factor_key = T)

df_long$value<-as.numeric(df_long$value)
df_long$order<-as.numeric(df_long$order)
```

```{r}
df_long$condition<-factor(df_long$condition, levels=c("MIC_10", "MIC_75", "MBC_10", "MBC_75"))

df_long%>%
  subset(bacteria != c("Subdoligranulum variable"))->final

final%>%
  mutate(bacteria = fct_reorder(bacteria, final$order))%>%
  ggplot(aes(y=bacteria))+
  stat_summary(fun="median", geom= "bar",  aes(x= value, fill=condition,group=condition), position= position_dodge(preserve = "single"), width =0.8, alpha=0.5, colour= "black")+
  geom_point(aes(x=value, colour=condition, group=condition), position=position_jitterdodge(jitter.width = 0.2,
  jitter.height = 0.05,
  dodge.width = 0.75,
  seed = NA), alpha=1, size=1)+
  scale_color_manual(values=c("goldenrod3","goldenrod1", "cyan4",  "cyan2"))+
  scale_fill_manual(values=c("goldenrod3","goldenrod1", "cyan4",  "cyan2"))+
  ggtitle(expression(MIC~and~MBC~of~H[2]*O[2]))+
  xlab(expression(H[2]*O[2]~(n*M)))+
  scale_x_continuous(labels=c("0 nM", 
                              "6.4 nM",  
                              "21 nM", 
                              "66 nM", 
                              expression("2.2"~mu*M), 
                              expression("6.8"~mu*M),  
                              expression("21"~mu*M),
                              expression("69"~mu*M),
                              expression("222"~mu*M),
                              expression("710"~mu*M),  
                              "2.3 mM", "7.3 mM" ), 
                     breaks=c(1, 2, 3, 4, 5, 6, 7,  8 ,9 ,10, 11, 12))+
  theme(axis.text.y= element_text(size=15, face = "italic"),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20),
        axis.text.x = element_text(size=15, angle=90, hjust=1, vjust=0),
        legend.text = element_text(size = 15),
        legend.title = element_text(size= 20),
        strip.text.y = element_text(size = 15 , face = "italic", angle=90),
        strip.background = element_blank(),
        plot.title = element_text(size=20),
        )+
  guides(fill=guide_legend(title="Assay") ,colour="none")->plot_MIC_vs_MBC_table





plot_MIC_vs_MBC_table

ggsave(filename = "MIC_MBC_H2O2.jpeg", 
       path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/output", 
       width = 18,
       height = 25,
       units = c("cm"))
```

```{r}

df_long$condition<-factor(df_long$condition, levels=c("MIC_10", "MIC_75", "MBC_10", "MBC_75"))

df_long%>%
  subset(bacteria != c("Subdoligranulum variable"))->final

final%>%
  subset(condition %in% c("MIC_10", "MIC_75"))->sub
  
sub%>%
  mutate(bacteria = fct_reorder(bacteria, sub$order))%>%
  ggplot(aes(y=bacteria))+
  stat_summary(fun="median", geom= "bar",  aes(x= value, fill=condition,group=condition), position= position_dodge(preserve = "single"), width =0.8, alpha=0.5, colour= "black")+
  geom_point(aes(x=value, colour=condition, group=condition), position=position_jitterdodge(jitter.width = 0.2,
  jitter.height = 0.05,
  dodge.width = 0.75,
  seed = NA), alpha=1, size=1)+
  scale_color_manual(values=c("goldenrod3",
                              # "goldenrod1", 
                              # "cyan4",  
                              "cyan4"))+
  scale_fill_manual(values=c("goldenrod3",
                             # "goldenrod1", 
                             # "cyan4",  
                             "cyan4"))+
  ggtitle(expression(MIC~and~MBC~of~H[2]*O[2]))+
  xlab(expression(H[2]*O[2]~(n*M)))+
  scale_x_continuous(labels=c("0 nM", 
                              "6.4 nM",  
                              "21 nM", 
                              "66 nM", 
                              expression("2.2"~mu*M), 
                              expression("6.8"~mu*M),  
                              expression("21"~mu*M),
                              expression("69"~mu*M),
                              expression("222"~mu*M),
                              expression("710"~mu*M),  
                              "2.3 mM", "7.3 mM" ), 
                     breaks=c(1, 2, 3, 4, 5, 6, 7,  8 ,9 ,10, 11, 12))+
  theme(axis.text.y= element_text(size=15, face = "italic"),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size=20),
        axis.text.x = element_text(size=15, angle=90, hjust=1, vjust=0),
        legend.text = element_text(size = 15),
        legend.title = element_text(size= 20),
        strip.text.y = element_text(size = 15 , face = "italic", angle=90),
        strip.background = element_blank(),
        plot.title = element_text(size=20),
        )+
  guides(fill=guide_legend(title="Assay") ,colour="none")->plot_MIC_vs_MBC_table





plot_MIC_vs_MBC_table

ggsave(filename = "MIC_H2O2_50.jpeg", 
       path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/output", 
       width = 18,
       height = 25,
       units = c("cm"))

```
## Export 
```{r}
# names(final_h2O2)[2]<-"value_H2O2"
# names(final_h2O2)[3]<-"condition_H2O2"
# Write the first data set in a new workbook
write.csv(final_h2O2, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_MBC_H2O2.csv")
```

## Go back to the heatplot with relative od values
```{r}
MBC_rel<-MBC_mod_av
MIC_rel<-MIC_mod_av

for (i in 1:nrow(MIC_rel)) { #vertical 
  for(j in 2:13) {#horizontal 
     MIC_rel[i,j] = MIC_rel[i,j]/MIC_rel[i, c("average")] 
  }}

for (i in 1:nrow(MBC_rel)) { #vertical 
  for(j in 2:13) {#horizontal 
     MBC_rel[i,j] = MBC_rel[i,j]/MBC_rel[i, c("average")] 
  }}


MBC_relgrowth_value<-cbind(MBC_rel, df_final_replicates)
MIC_relgrowth_value<-cbind(MIC_rel, df_final_replicates)


MIC_rel_long<-gather(MIC_relgrowth_value, condition, value, "1":"12", factor_key = T)
MIC_rel_long$assay<-c("MIC")
MBC_rel_long<-gather(MBC_relgrowth_value, condition, value, "1":"12", factor_key = T)
MBC_rel_long$assay<-c("MBC")

MBC_MIC_rel_long<-rbind(MIC_rel_long, MBC_rel_long)


```


```{r}
MBC_MIC_rel_long$value[MBC_MIC_rel_long$value <0.1]<-0


MBC_MIC_rel_long$condition<-as.numeric(MBC_MIC_rel_long$condition)

for (i in 1:nrow(MBC_MIC_rel_long)){
  if (MBC_MIC_rel_long[i, c("assay")] == "MIC" &  MBC_MIC_rel_long[i, c("condition")] == MBC_MIC_rel_long[i, c("MIC_10")]) { 
    MBC_MIC_rel_long[i, c("label")] = MBC_MIC_rel_long[i, c("MIC_10")]}
  
  
   if (MBC_MIC_rel_long[i, c("assay")] == "MBC" &  MBC_MIC_rel_long[i, c("condition")] == MBC_MIC_rel_long[i, c("MBC_10")]) { 
    MBC_MIC_rel_long[i, c("label")] =  MBC_MIC_rel_long[i, c("MBC_10")]
   }}

MBC_MIC_rel_long$label<-as.numeric(MBC_MIC_rel_long$label)



```


```{r}
MBC_MIC_rel_long%>%
  subset(!bacteria %in% c("Subdoligranulum variable", "Anaerobutyricum hallii", "Marvinbryantia formatixigens", "Ruminococcus bromii"))->hoi

hoi%>%
  mutate(bacteria = fct_reorder(bacteria, hoi$order))%>%
  ggplot(aes(x = condition, y = assay, fill = value)) + 
  geom_raster() +
  # scale_fill_continuous(limits=c(0, 2), breaks = c(0,0.5, 1, 1.5, 2))+
  labs(x=expression(paste("H"[2]*"O"[2]*" concentration")))+
  theme(text = element_text(size=15), 
        axis.text.x = element_text(angle = 90, vjust= 0.5, hjust=1),
        axis.title.y= element_blank(),
        axis.text.y=element_text(size=10),
        strip.text.y = element_text(angle = 0, face = "italic", hjust=0),
        strip.background = element_blank())+
  facet_grid(rows =vars(bacteria), scales = "free_y", space = "free")+
  geom_point(aes(x=label, y=assay, color=assay), alpha=0.5, position=position_jitterdodge(jitter.width = 0.3, jitter.height = 0.1))+
  # geom_text(aes(label=label, color=assay))+
  scale_x_continuous(labels=c("0 nM", 
                              "6.4 nM",  
                              "21 nM", 
                              "66 nM", 
                              expression("2.2"~mu*M), 
                              expression("6.8"~mu*M),  
                              expression("21"~mu*M),
                              expression("69"~mu*M),
                              expression("222"~mu*M),
                              expression("710"~mu*M),  
                              "2.3 mM", "7.3 mM" ), 
                     breaks=c(1, 2, 3, 4, 5, 6, 7,  8 ,9 ,10, 11, 12))+
  labs(fill = expression(relative~OD[600]), colour="")+
  ggtitle(expression(The~MIC~and~MBC~of~H[2]*O[2]))



ggsave(filename = "MIC_MBC_h2o2_groeth.jpeg", 
       path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/output", 
       width = 18,
       height = 30,
       units = c("cm"))



```

