---
title: "20221214_MIC_MBC_oxygen"
output: html_document
date: '2022-12-14'
---

```{r setup, echo =FALSE}
.libPaths('C:\\Users\\zuendj\\Documents\\R4Libs')
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/zuendj/Desktop/03_data R/oxidative stress", cho = TRUE, warning = FALSE, message = FALSE)

# Install Packages:
# install.packages("rlang")
# install.packages("tidyr")
# install.packages("ggbreak")

# unload("mia")
library(tidyverse)
library(ggplot2)
library(tidyr)
# install.packages("devtools")
# devtools::install_github("slowkow/ggrepel")
library(ggrepel)
library(ggbreak)
library(openxlsx)
```

##Load the Data
```{r}



bacteria_MIC <- list.files(path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MIC")
bacteria_MBC <- list.files(path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MBC")
#bacteria<- bacteria[-(27:29)]


options(scipen=999)


#define empty matrices, no values added so far 
MIC_average<- matrix(0, length(bacteria_MIC), 13)
MBC_average<- matrix(0, length(bacteria_MBC), 13)

blank_corrected_MIC<- matrix(0, length(bacteria_MIC)*6, 13)
blank_corrected_MBC<- matrix(0, length(bacteria_MBC)*6, 13)

#define MIC and MBC value for each species 
#MIC, fill values into MIC, here OD corrected values, but not corrected with agar 
row = 0

setwd("C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MIC")
for (l in 1:length(bacteria_MIC)) {
  #generate MICwide format
  MICwide = read.csv(bacteria_MIC[l], sep=";", header=F, check.names =F)
  #look for A indicating the area in the excel file with the data
  for (r in 1:40) {
    if (MICwide[r,1]=="A") {
      zeile = r
    }
  }
#########################################
  # print(bacteria_MIC[l])
  row = (l-1)*6
  # print(row)

  #generate blank corrected values
  for(i in 1:12) {
    #x indicated the colum->'A' is in column 1 and the data next to it from column 2 on
    x = 1+i
    zeile_end = zeile+6
    d = as.numeric(unlist(data.frame(MICwide[zeile:zeile_end, x])))
    for(j in 1:6){
      y = d[j] - d[7]
      blank_corrected_MIC[row+j, i] = y
    }
  }
  
  
  

  
  #########################################
  #generate averages 
  for(i in 1:12) {
    r1= row+1
    r2= row+6
    MIC_average[l, i] = as.numeric(mean(blank_corrected_MIC[r1:r2, i],  na.rm=TRUE))
  }
} 








#MBC
setwd( "C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2/MBC")
row = 0
for (l in 1:length(bacteria_MBC)) {
  #generate MICwide format
  MBCwide = read.csv(bacteria_MBC[l], sep=";", header=F, check.names =F)
  #look for A indicating the area in the excel file with the data
  for (r in 1:40) {
    if (MBCwide[r,1]=="A") {
      zeile = r
    }
  }
  #########################################
  # print(bacteria_MBC[l])
  row = (l-1)*6
  # print(row)
  
  #generate blank corrected values
  for(i in 1:12) {
    #x indicated the colum->'A' is in column 1 and the data next to it from column 2 on
    x = 1+i
    zeile_end = zeile+6
    d = as.numeric(unlist(data.frame(MBCwide[zeile:zeile_end, x])))
    for(j in 1:6){
      y = d[j] - d[7]
      blank_corrected_MBC[row+j, i] = y
    }
  }
  
  #########################################
  #generate averages 
  for(i in 1:12) {
    r1= row+1
    r2= row+6
    MBC_average[l, i] = as.numeric(mean(blank_corrected_MBC[r1:r2, i],  na.rm=TRUE))
  }
} 

```


## Get the MIC for individual repleciates
```{r}
#########################################
#define row names for the blank corrected 
bacteria <- strsplit(bacteria_MBC, ".csv")
bacteria <- as.character(bacteria)

row_names_mbc<-matrix(0,length(bacteria)*6,1)
position = 0
for (i in 1:length(bacteria)) {
  for (j in 1:6) {
    row_names_mbc[position+j,1] = bacteria[i]
  }
  position = position+6
}


bacteria <- strsplit(bacteria_MIC, ".csv")
bacteria <- as.character(bacteria)

row_names_mic<-matrix(0,length(bacteria)*6,1)
position = 0
for (i in 1:length(bacteria)) {
  for (j in 1:6) {
    row_names_mic[position+j,1] = bacteria[i]
  }
  position = position+6
}


MIC_replicates_h2o2 <-data.frame(row_names_mic, blank_corrected_MIC)

colnames(MIC_replicates_h2o2)<-list("bacteria", 0, 0.06, 0.021, 0.66, 2.21, 6.77, 21.66, 69.31, 221.8, 709.7, 2271.25, 7268, 8000)

MBC_replicates_h2o2 <-data.frame(row_names_mbc, blank_corrected_MBC)
colnames(MBC_replicates_h2o2)<-list("bacteria",0, 0.06, 0.021, 0.66, 2.21, 6.77, 21.66, 69.31, 221.8, 709.7, 2271.25, 7268, 8000)
```

```{r}
write.xlsx(MBC_replicates_h2o2, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MBC_H2O2_replicates.xlsx")
write.xlsx(MIC_replicates_h2o2, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_H2O2_replicates.xlsx")



MIC_replicates_h2o2[c(24, 161, 81),c("7268")]<-0
MIC_replicates_h2o2[c(81),c("2271.25")]<-0

MBC_replicates_h2o2[c(69, 161, 162),c("2271.25")]<-0
MBC_replicates_h2o2[c(171),c("7268")]<-0




# MBC_mod<-read.xlsx("C:/Users/zuendj/Desktop/03_data R/oxidative stress/MBC_H2O2_replicates_mod.xlsx")
# MBC_mod[is.na(MBC_mod)] <- 0
# MIC_mod<-read.xlsx("C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_H2O2_replicates_mod.xlsx")
# MIC_mod[is.na(MIC_mod)] <- 0
```



```{r}

average<-aggregate(MIC_replicates_h2o2$`0`, list(MIC_replicates_h2o2$bacteria), FUN=mean)
names(average)<-c("bacteria", "average")
MIC_mod_av<-left_join(MIC_replicates_h2o2, average)



average<-aggregate(MBC_replicates_h2o2$`0`, list(MBC_replicates_h2o2$bacteria), FUN=mean)
names(average)<-c("bacteria", "average")
MBC_mod_av<-left_join(MBC_replicates_h2o2, average)

MIC_mod_av[is.na(MIC_mod_av)] <- 0
MBC_mod_av[is.na(MBC_mod_av)] <- 0


MIC_vector <- vector()
for (i in 1:nrow(MIC_mod_av)) { #vertical 
  candidates <- vector()
     for(j in 2:13) {#horizontal 
       if (MIC_mod_av[i,j]>0.02 & MIC_mod_av[i,j]/MIC_mod_av[i, 15]>0.1) {#-> MIC_value_absolut)

         candidates <- append(candidates, colnames(MIC_mod_av)[j])
         candidates <-as.numeric(candidates)
         # print((MIC_replicates_h2o2)[j,1])
       }
     }
  MIC_vector <- append(MIC_vector, max(candidates))
}


MBC_vector <- vector()
for (i in 1:nrow(MBC_mod_av)) { #vertical 
  candidates <- vector()
  for(j in 2:13) {#horizontal 
    if (MBC_mod_av[i,j]>0.02 & MBC_mod_av[i,j]/MBC_mod_av[i, 15]>0.1) {#-> MIC_value_absolut)
      
      candidates <- append(candidates, colnames(MBC_mod_av)[j])
      candidates <-as.numeric(candidates)
    }
  }
  MBC_vector <- append(MBC_vector, max(candidates))
}

```

```{r}

MBC<-MBC_vector

MBC_values <- as.data.frame(cbind(row_names_mbc, MBC_vector))
MIC_values <- as.data.frame(cbind(row_names_mic, MIC_vector))

names(MBC_values)[1]<-"species"
names(MBC_values)[2]<-"value"
MBC_values$condition<-"MBC"

names(MIC_values)[1]<-"species"
names(MIC_values)[2]<-"value"
MIC_values$condition<-"MIC"


final_h2O2 <-rbind(MBC_values, MIC_values)

final_h2O2$value<-as.numeric(final_h2O2$value)




mean_ambc <- aggregate(final_h2O2$value, list(final_h2O2$condition, final_h2O2$species), FUN=mean)
mean_ambc%>%
  subset(Group.1 %in% "MBC")->mean_mbc

        names(mean_mbc)[2]<-"species"
        names(mean_mbc)[3]<-"mean_mbc"

        
left_join(final_h2O2, mean_mbc, by="species")->final

```

```{r}

length(
  bacteria
)

final%>%
  subset(bacteria != c("Subdoligranulum variable"))->final

final%>%
  mutate(bacteria = fct_reorder(species, final$mean_mbc))%>%
  ggplot(aes(y=bacteria))+
  stat_summary(fun="median", geom= "bar", aes(x= value, fill=condition), position= position_dodge(preserve = "single"), width =0.8, alpha=0.5, colour= "black")+
  geom_point(aes(x=value, colour=condition, group=condition), position=position_jitterdodge(jitter.width = 0.2,
  jitter.height = 0.05,
  dodge.width = 0.75,
  seed = NA), alpha=1, size=1)+
  scale_color_manual(values=c("goldenrod2", "cyan4"))+
  scale_fill_manual(values=c("goldenrod2", "cyan4"))+
  # stat_summary(aes(x=MIC, colour=condition1), geom="point", fun="mean", alpha=0.5)+
  # stat_summary(aes(x=MIC, colour=condition1), geom="errorbar", fun.data="mean_se", alpha=0.5)+
  # stat_summary(aes(x=MBC, colour=condition2), geom="point", fun="mean", alpha=0.5)+
  # stat_summary(aes(x=MBC, colour=condition2), geom="errorbar", fun.data="mean_se", alpha=0.5)+
  # coord_trans(x="log2")+
  ggtitle(expression(MIC~and~MBC~of~H[2]*O[2]))+
  xlab(expression(H[2]*O[2]~(mu*M)))+
  # facet_grid(rows=vars(species), scales="free", space="free_x", switch= "y")+
  # force_panelsizes(cols = c(5, 0.3))+
  # scale_x_break(c(6000, 6500), scale=0.1)+
  scale_x_log10(breaks=c(0.06, 0.021, 0.66, 2.21, 6.77, 21.66, 69.31, 221.8, 709.7, 2271.25, 7268))+
  theme(axis.text.y= element_text(size=15, face = "italic"), 
        axis.title.y = element_blank(), 
        axis.title.x = element_text(size=20),
        axis.text.x = element_text(size=15, angle=90),
        legend.text = element_text(size = 15),
        legend.title = element_text(size= 20),
        strip.text.y = element_text(size = 15 , face = "italic", angle=90),
        strip.background = element_blank(),
        plot.title = element_text(size=20),
        )+
  guides(fill=guide_legend(title="Assay") ,colour="none")->plot_MIC_vs_MBC_table



plot_MIC_vs_MBC_table

ggsave(filename = "MIC_MBC_H2O2.jpeg", 
       path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/output", 
       width = 18,
       height = 25,
       units = c("cm"))


```
```{r}
names(final_h2O2)[2]<-"value_H2O2"
names(final_h2O2)[3]<-"condition_H2O2"
# Write the first data set in a new workbook
write.csv(final_h2O2, file = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/MIC_MBC_H2O2.csv")
```


