---
title: "Relative metabolites H2O2"
output: html_document
date: '2022-12-29'
---
```{r setup, echo =FALSE}
.libPaths('C:\\Users\\zuendj\\Documents\\R4Libs')
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/zuendj/Desktop/03_data R/oxidative stress", cho = TRUE, warning = FALSE, message = FALSE)

# Install Packages:
# install.packages("rlang")
# install.packages("tidyr")
# install.packages("ggbreak")

library(ggpmisc)
library(tidyverse)
library(ggplot2)
library(tidyr)
# install.packages("devtools")
# devtools::install_github("slowkow/ggrepel")
library(ggrepel)
library(ggbreak)
library(openxlsx)
library(readxl)
```
##1. Read all the data into one df
```{r}
setwd("P:/Shared_documents/Janina Zünd/08_phd/04_experimentation/07_H202 MIC")
hplc_raw <- read.xlsx("20221220_final mic_hplc data_corrected blank.xlsx")
```

```{r}
hplc_raw%>%
  subset(remove_for_data_analysis != "yes")%>%
  subset(condition != "blank")->subset

subset[is.na(subset[])] <- 0


subset<-subset[, c(1, 2, 21, 22, 23, 24, 25, 27)]
```


##2. Calculate relative values
```{r}
##starting again with the wide table

#define new df for relative values
HPLC_values_relative_wide <- subset

HPLC_values<- subset
#calculate relative values; first calculate total SCFA
HPLC_values$total_SCFA<-0

for (i in 1:nrow(HPLC_values)){
  x<-HPLC_values[i,c(3:8)]
  HPLC_values[i,9]<- sum(x[x>0])
  
  for (j in 3:8){
    HPLC_values_relative_wide[i,j] = HPLC_values[i,j] / HPLC_values[i, 9]
  }
}
```



```{r}
#transform into long
HPLC_relative_long <-  gather(HPLC_values_relative_wide, metabolite, concentration, "Succinate":"Butyrate", factor_key = T ) 
```





##3. Calculate means & SD -> replicates do not correspont to each other -> better display mean

```{r}
mean_metabolites <- aggregate(HPLC_relative_long$concentration, list(HPLC_relative_long$assay, HPLC_relative_long$condition, HPLC_relative_long$metabolite), FUN=mean)

sdv <- aggregate(HPLC_relative_long$concentration, list(HPLC_relative_long$assay, HPLC_relative_long$condition, HPLC_relative_long$metabolite), FUN=sd)

names(mean_metabolites)<-c("Bacteria",  "condition", "metabolite",  "mean_conc")
names(sdv)<-c("Bacteria",  "condition", "metabolite",  "sd")


total_means<-join(mean_metabolites, sdv)


total_means%>%
  subset(condition %in% c("control"))->control_means

names(control_means)[5]<-"sd_control"
names(control_means)[4]<-"mean_control"

control_means<-control_means[, -c(2)]


total_means%>%
  subset(condition %in% c("NIC"))->NIC_means

names(NIC_means)[5]<-"sd_h2o2"
names(NIC_means)[4]<-"mean_h2o2"

NIC_means<-NIC_means[, -c(2)]

NIC_means%>%
  subset(mean_h2o2 != "NaN")->NIC_means




total_means%>%
  subset(condition %in% c("NIC-1"))->NIC_1_means

names(NIC_1_means)[5]<-"sd_h2o2"
names(NIC_1_means)[4]<-"mean_h2o2"

NIC_1_means<-NIC_1_means[, -c(2)]

NIC_1_means%>%
  subset(mean_h2o2 != "NaN")->NIC_1_means



means_corr_nic<-inner_join(control_means, NIC_means)
means_corr_nic$condition<-"NIC"


means_corr_nic_1<-inner_join(control_means, NIC_1_means)
means_corr_nic_1$condition<-"NIC-1"


all_means<-rbind(means_corr_nic, means_corr_nic_1)

```

##4. Plots with means

```{r}
setwd("C:/Users/zuendj/Desktop/03_data R/oxidative stress/output")

bacteria_names<-unique(all_means$Bacteria)


for (i in 1:length(bacteria_names)) {
  # for (i in 1:1) {
##create subset 
    
    
    all_means%>%
      subset(Bacteria %in% c(bacteria_names[i]))->bacteria_subset
  
  plot <-ggplot(bacteria_subset, aes(y=mean_control, x=mean_h2o2))+
    geom_abline(intercept=0, slope=1, color="darkgrey", size=0.75, alpha=0.5, linetype =3)+
    stat_poly_line(color="darkgrey", b_0.constant =T) +
    geom_point(aes(colour=metabolite, shape=condition), size=3, alpha=0.5) +
    geom_errorbar(aes(ymin=(mean_control - sd_control), ymax=(mean_control + sd_control), colour=metabolite, group=condition))+
    geom_errorbarh(aes(xmin=mean_h2o2 - sd_h2o2, xmax=mean_h2o2 + sd_h2o2, colour=metabolite, group=condition))+
    coord_fixed()+
    #expand_limits(x=c(0.05, 1), y=c(0.05, 1))+
    # geom_abline(intercept=0.0, slope=1.1111111, color="darkgrey", size=0.75, alpha=0.5, linetype =3)+
    # geom_abline(intercept=-0.0, slope=0.9, color="darkgrey", size=0.75, alpha=0.5, linetype =3 )+
    ggtitle(bacteria_names[i])+
    labs(x=expression(H[2]*O[2]), y="control")+
    stat_poly_eq(b_0.constant =T)+
    scale_x_continuous( limits = c(-1, 1.1), labels = label_number(accuracy = 0.01)) +
    scale_y_continuous( limits = c(-1, 1.1), labels = label_number(accuracy = 0.01))
  show(plot)
  
  x<-paste0(bacteria_names[i], ".jpg")
  
  ggsave(filename = x,   
         path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/output/corr_H2O2", 
         width = 18,
         height = 15,
         units = c("cm"))
  
  }




```

## display absolute values




```{r}
#transform into long
HPLC_relative_long <-  gather(HPLC_values, metabolite, concentration, "Succinate":"Butyrate", factor_key = T ) 
```
```{r}
############################
#PLOT ABSOLUTE - blank corrected
###############################

# #plot single bactrium
# p_box_subset<-ggplot(subset(HPLC_values_blank_corrected_names, row_names %in% c("Anaerostipes_caccae") & metabolite %in% c("succinate", "lactate", "formate", "acetate", "propionate", "butyrate")), aes(x=metabolite, y=concentration, fill=condition)) +
#   stat_summary(fun = mean, geom = "bar", position = position_dodge(1), color = "black") +
#   stat_summary(fun.data = mean_se, geom = "errorbar" , width = .5, position = position_dodge(1)) +
#   #scale_fill_manual(values=c('darkgoldenrod1', "cyan4"))+
#   facet_grid( rows=vars(condition_agar), cols= vars(metabolite), scales = "free", switch="y")+
#   #geom_hline(yintercept=0)+
#   theme()+
#   ylab("metabolites produced [%]")
# 
# 
# p_box_subset



#loop for plots for all bacteria
for (i in 1:length(bacteria_names)) {
##create subset
HPLC_relative_long%>%
    subset(assay %in% bacteria_names[i])->bacteria_subset

  t<-paste0(bacteria_names[i])

  p_individual<-ggplot(bacteria_subset, aes(x=metabolite, y=concentration, fill=condition)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(1), color = "black") +
    stat_summary(fun.data = mean_se, geom = "errorbar" , width = .5, position = position_dodge(1)) +
    #scale_fill_manual(values=c('darkgoldenrod1', "cyan4"))+
    facet_grid( cols= vars(metabolite), scales = "free", switch="y")+
    #geom_hline(yintercept=0)+
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank() )+
    ggtitle(t)+
    ylab("metabolites produced [mM]")
  #scale_y_continuous(limits = c(-0.5, 1))+


  x<-paste0(bacteria_names[i], ".jpg")

  ggsave(filename = x, path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/output/absolute_H2O2",
         width = 14,
         height = 12,
         units = c("cm"))
  }
```

##3. Calculate means & SD -> replicates do not correspont to each other -> better display mean

```{r}
mean_metabolites <- aggregate(HPLC_relative_long$concentration, list(HPLC_relative_long$assay, HPLC_relative_long$condition, HPLC_relative_long$metabolite), FUN=mean)

sdv <- aggregate(HPLC_relative_long$concentration, list(HPLC_relative_long$assay, HPLC_relative_long$condition, HPLC_relative_long$metabolite), FUN=sd)

names(mean_metabolites)<-c("Bacteria",  "condition", "metabolite",  "mean_conc")
names(sdv)<-c("Bacteria",  "condition", "metabolite",  "sd")


total_means<-join(mean_metabolites, sdv)


total_means%>%
  subset(condition %in% c("control"))->control_means

names(control_means)[5]<-"sd_control"
names(control_means)[4]<-"mean_control"

control_means<-control_means[, -c(2)]


total_means%>%
  subset(condition %in% c("NIC"))->NIC_means

names(NIC_means)[5]<-"sd_h2o2"
names(NIC_means)[4]<-"mean_h2o2"

NIC_means<-NIC_means[, -c(2)]

NIC_means%>%
  subset(mean_h2o2 != "NaN")->NIC_means




total_means%>%
  subset(condition %in% c("NIC-1"))->NIC_1_means

names(NIC_1_means)[5]<-"sd_h2o2"
names(NIC_1_means)[4]<-"mean_h2o2"

NIC_1_means<-NIC_1_means[, -c(2)]

NIC_1_means%>%
  subset(mean_h2o2 != "NaN")->NIC_1_means



means_corr_nic<-inner_join(control_means, NIC_means)
means_corr_nic$condition<-"NIC"


means_corr_nic_1<-inner_join(control_means, NIC_1_means)
means_corr_nic_1$condition<-"NIC-1"


all_means<-rbind(means_corr_nic, means_corr_nic_1)

```

##4. Plots with means-absolute

```{r}
setwd("C:/Users/zuendj/Desktop/03_data R/oxidative stress/output")

bacteria_names<-unique(all_means$Bacteria)


for (i in 1:length(bacteria_names)) {
  # for (i in 1:1) {
##create subset 
    
    
    all_means%>%
      subset(Bacteria %in% c(bacteria_names[i]))->bacteria_subset
  
  plot <-ggplot(bacteria_subset, aes(y=mean_control, x=mean_h2o2))+
    geom_abline(intercept=0, slope=1, color="darkgrey", size=0.75, alpha=0.5, linetype =3)+
    stat_poly_line(color="darkgrey", b_0.constant =T) +
    geom_point(aes(colour=metabolite, shape=condition), size=3, alpha=0.5) +
    geom_errorbar(aes(ymin=(mean_control - sd_control), ymax=(mean_control + sd_control), colour=metabolite, group=condition))+
    geom_errorbarh(aes(xmin=mean_h2o2 - sd_h2o2, xmax=mean_h2o2 + sd_h2o2, colour=metabolite, group=condition))+
    coord_fixed()+
    #expand_limits(x=c(0.05, 1), y=c(0.05, 1))+
    # geom_abline(intercept=0.0, slope=1.1111111, color="darkgrey", size=0.75, alpha=0.5, linetype =3)+
    # geom_abline(intercept=-0.0, slope=0.9, color="darkgrey", size=0.75, alpha=0.5, linetype =3 )+
    ggtitle(bacteria_names[i])+
    labs(x=expression(H[2]*O[2]), y="control")+
    stat_poly_eq(b_0.constant =T)+
    scale_x_continuous( limits = c(-35, 40), labels = label_number(accuracy = 0.01)) +
    scale_y_continuous( limits = c(-35, 40), labels = label_number(accuracy = 0.01))
  show(plot)
  
  x<-paste0(bacteria_names[i], ".jpg")
  
  ggsave(filename = x,   
         path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/output/corr_H2O2_absolute", 
         width = 18,
         height = 15,
         units = c("cm"))
  
  }




```
```{r}

#########################################
#Assign phyla to species name
########################################
bacteria_pyla<-as.data.frame(unique(all_means[,1]))

bacteria_pyla$class<-0
bacteria_pyla<-as.data.frame(bacteria_pyla)


names(bacteria_pyla)<-c("Bacteria", "class")

###
bacteroidetes<-grep("Bac", bacteria_pyla$Bacteria)
bacteria_pyla[bacteroidetes, c(2)] ="Bacteroidia"

pre<-grep("Prevo", bacteria_pyla$Bacteria)
bacteria_pyla[pre,2]="Bacteroidia"

parabac<-grep("Parabac", bacteria_pyla$Bacteria)

bacteria_pyla[parabac,2]="Bacteroidia"

blaut<-grep("Blaut", bacteria_pyla$Bacteria)
bacteria_pyla[blaut,2]="Clostridia"

rumi<-grep("Rumi", bacteria_pyla$Bacteria)
bacteria_pyla[rumi,2]="Clostridia"

rose<-grep("Rose", bacteria_pyla$Bacteria)
bacteria_pyla[rose,2]="Clostridia"

clo<-grep("Clo", bacteria_pyla$Bacteria)
bacteria_pyla[clo,2]="Clostridia"

Faec<-grep("Faecalibacterium", bacteria_pyla$Bacteria)

bacteria_pyla[Faec,2]="Clostridia"

flavi<-grep("Flavi", bacteria_pyla$Bacteria)



bacteria_pyla[flavi,2]="Clostridia"

copr<-grep("Copro", bacteria_pyla$Bacteria)
bacteria_pyla[copr,2]="Clostridia"

eu<-grep("Eu", bacteria_pyla$Bacteria)
bacteria_pyla[eu,2]="Clostridia"

flavi<-grep("Flavo", bacteria_pyla$Bacteria)
bacteria_pyla[flavi,2]="Clostridia"

lacto<-grep("Lactobacillus", bacteria_pyla$Bacteria)
bacteria_pyla[lacto,2]="Bacilli"

subdo<-grep("Sub", bacteria_pyla$Bacteria)
bacteria_pyla[subdo,2]="Clostridia"

bif<-grep("Bif", bacteria_pyla$Bacteria)
bacteria_pyla[bif,2]="Actinomycetia"

colin<-grep("Collin", bacteria_pyla$Bacteria)
bacteria_pyla[colin,2]="Coriobacteriia"



anaero<-grep("Anaero", bacteria_pyla$Bacteria)
bacteria_pyla[anaero,2]="Clostridia"

anaro<-grep("Anaro", bacteria_pyla$Bacteria)
bacteria_pyla[anaro,2]="Clostridia"

marvin<-grep("Marvin", bacteria_pyla$Bacteria)
bacteria_pyla[marvin,2]="Clostridia"

phasc<-grep("Phasco", bacteria_pyla$Bacteria)
bacteria_pyla[phasc,2]="Negativicutes"

entero<-grep("Entero", bacteria_pyla$Bacteria)
bacteria_pyla[entero,2]="Bacilli"

esch<-grep("Esch", bacteria_pyla$Bacteria)
bacteria_pyla[esch,2]="Gammaproteobacteria"
#########################

names(bacteria_pyla)<-c("Bacteria", "Class")

```

```{r}
ratio<-all_means

ratio<-join(ratio, bacteria_pyla, by= "Bacteria")

# ratio$mean_control[ratio$mean_control<0.001]<-0
# ratio$mean_h2o2[ratio$mean_h2o2<0.001]<-0

ratio$ratio <-  ratio$mean_h2o2 -ratio$mean_control 




ggplot(subset(ratio, condition %in% "NIC"), aes(x=metabolite, y=Bacteria, fill=ratio))+
  geom_tile()+
  scale_fill_gradientn(colors = c("coral", "white", "cyan4"), values = rescale(c(-0.5,0,0.4)))+
  facet_grid(rows=vars(Class), space="free", scale="free")+
  theme(strip.text.y = element_text(angle=0, size = 15),
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 90, size=15, vjust=0.2),
        axis.text.y = element_text(size=15, face="italic"))+
  labs(fill="Δrel. metabolites")


 ggsave(filename = "H2O2_heatplot.jpeg",   
         path = "C:/Users/zuendj/Desktop/03_data R/oxidative stress/output", 
         width = 22,
         height = 20,
         units = c("cm"))

```



###5. PCA plot
```{r}

HPLC_values%>% 
  subset(assay %in% c("Anarostipes caccae", "Anaerostipes hadrus"))->df



metabolites.pca <- prcomp(df[,c(5,6,8,9)],
                   center = TRUE,
                   scale. = TRUE)


# install.packages("ggfortify")

library(ggfortify)

pca.plot <- autoplot(metabolites.pca,
                          data = df,
                          colour = 'condition',
                     shape="assay",
                     loadings = T, loadings.colour = 'blue',
                     # alpha="inoculum_dilution",
         loadings.label = T, loadings.label.size = 3)
  
pca.plot

  

```

