---
title: "Relative metabolites H2O2"
output: html_document
date: '2022-12-29'
---
```{r setup, echo =FALSE}
.libPaths('C:\\Users\\zuendj\\Documents\\R4Libs')
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/zuendj/Desktop/03_data R/oxidative stress", cho = TRUE, warning = FALSE, message = FALSE)

# Install Packages:
# install.packages("rlang")
# install.packages("tidyr")
# install.packages("ggbreak")

# library(ggpmisc)
# library(tidyverse)
# library(ggplot2)
# library(tidyr)
# install.packages("devtools")
# devtools::install_github("slowkow/ggrepel")
# library(ggrepel)
# library(ggbreak)
# library(openxlsx)
# library(readxl)
# library(ggh4x)
# library(ggpubr)
# library(ggpubr)
# library(rstatix)
# library(dplyr)
```

# 1. Read all the data into one df
```{r}
setwd("C:/Users/zuendj/Desktop/03_data R/oxidative stress/input/h2o2")
hplc_raw <- read.csv(file= "20221220_final mic_hplc data_corrected blank_only_knon_metabolites.csv", sep=";")
```

#6. Assign taxonomy to bacteria name

```{r}
taxonomy = read.csv(file = "P:/Shared_documents/Janina_Zuend/08_phd/12_working_package_2/Strain_panel.csv", sep=";", header=T, check.names =F)
colnames(taxonomy)[colnames(taxonomy) == "bacteria"] <- "assay"

tax<-left_join(hplc_raw, taxonomy)

```


```{r}
##exclude samples
hplc_raw%>%
    # subset(remove_for_data_analysis != "yes")%>%
  subset(condition != "blank")->subset

# subset[is.na(subset[])] <- 0

subset<-subset[, c("rep","assay","remove_for_data_analysis", "condition","Succinat_.mM.", "Lactat_.mM.", "Formiat_.mM.", "Acetat_.mM.", "Butyrat_.mM.",  "Succinate", "Lactate", "Formate", "Acetate", "Propionate", "Butyrate")]
# names(subset)<-c("rep","assay", "condition", "abs_succinate", "abs_lactate", "abs_formate", "abs_acetate", "abs_propionate", "abs_butyrate")
```


# 2. Calculate relative values
```{r}
#define new df for relative values
HPLC_wide_h2o2 <- subset
#calculate relative values; first calculate total SCFA



##values have to be numeric
numeric_columns <- c("Succinate", "Lactate", "Formate", "Acetate", "Propionate", "Butyrate")
HPLC_wide_h2o2[, numeric_columns] <- sapply(HPLC_wide_h2o2[, numeric_columns], as.numeric)


#calculate relative values; first calculate total SCFA
HPLC_wide_h2o2$total_SCFA<-NA


scfas<-c("succinate", "lactate" , "formate", "acetate","propionate","butyrate")
scfas_rel<-paste0(scfas, "_rel_mM")
scfas_rel_C<-paste0(scfas, "_rel_C")
number_c <- c(4, 3, 1, 2, 3, 4) #nuber of c atoms for each organic acid

###calculate the relative values based on mM
for (i in 1:nrow(HPLC_wide_h2o2)){
  x<-HPLC_wide_h2o2[i,c(numeric_columns)]
  HPLC_wide_h2o2[i,c("total_mM")]<-  sum(x[which(x>0)])
  
  for (j in 1:length(scfas)){
    HPLC_wide_h2o2[i,scfas_rel[j]] = HPLC_wide_h2o2[i,numeric_columns[j]] / HPLC_wide_h2o2[i, c("total_mM")]
  }
}

## calculate the relative values based in total C
for (i in 1:nrow(HPLC_wide_h2o2)){
  vec<-c(HPLC_wide_h2o2[i,c("Lactate")]*3,
         HPLC_wide_h2o2[i,c("Formate")]*1,
         HPLC_wide_h2o2[i,c("Succinate")]*4,
         HPLC_wide_h2o2[i,c("Butyrate")]*4,
         HPLC_wide_h2o2[i,c("Propionate")]*3,
         HPLC_wide_h2o2[i,c("Acetate")]*2)
  HPLC_wide_h2o2[i,c("total_C")]<-  sum(vec[which(vec>0 )])
  
  for (j in 1:length(scfas)){
    HPLC_wide_h2o2[i,scfas_rel_C[j]] = HPLC_wide_h2o2[i,numeric_columns[j]]*number_c[j]/ HPLC_wide_h2o2[i, c("total_C")]
  }
}

 HPLC_wide_h2o2 %>%
   mutate(total_C = ifelse(total_C == 0, NA, total_C))%>%
   mutate(total_C = ifelse(total_mM == 0, NA, total_mM))->outlier_corr
```


# Test statistical differences in total metabolites
```{r}
# library(ggpubr)
#calculate mean and sd for bar plot
HPLC_wide_h2o2%>%
  subset(!assay %in% c("Subdoligranulum variabile", "Ruminococcus bromi", "Phascolarctobacterium succinatutens", "Anaerobutyricium hallii", "Marvinbryantiaformatixigens", "Anaerobutyricum hallii"))->HPLC_wide_h2o2

# unique(HPLC_wide_h2o2$assay)


left_join(setNames(aggregate(outlier_corr$total_C, by=list(outlier_corr$condition,  outlier_corr$assay), FUN=sd, na.rm=T), c("condition",  "assay", "sd")),
setNames(aggregate(outlier_corr$total_C, by=list(outlier_corr$condition,  outlier_corr$assay), FUN=mean, na.rm=T), c("condition", "assay", "mean")))->mean_h2o2

#get vector for ordering the taxa in teh plot
# mean %>%
#   pivot_wider(names_from = condition, values_from = mean)%>%
#   mutate(diff=anaerobe - aerobe)%>%
#   gather(condition, mean, "aerobe":"anaerobe")%>%
#   subset(condition %in% "aerobe")%>%
#   mutate(assay = factor(assay))%>%
#   mutate(assay= reorder(assay, diff))->order

#test for normality
HPLC_wide_h2o2[, c("assay", "condition", "total_C")]%>%
  group_by(assay, condition)%>%
  shapiro_test(total_C)%>%
  subset(p<0.05)->shapi

shapi[, c("assay")]->shapi
shapi$sig <- "non_normal"

#t test
HPLC_wide_h2o2[, c("assay", "condition", "total_C")]%>%
  mutate(condition = factor(condition, levels=c("control", "NIC-1", "NIC")))%>%
  group_by(assay)%>%
  t_test(total_C ~ condition, ref.group = "control")%>%
  add_significance()%>%
  add_xy_position( x="condition")->stats

left_join(stats, shapi)%>%  
  mutate(p.signif = case_when(
        sig == "non_normal" ~ "ns",
        TRUE ~ p.adj.signif)) ->stats

mean_h2o2%>%
  subset(!assay %in% c("Subdoligranulum variable", "Ruminococcus bromii", "Phascolarctobacterium succinatutens", "Anaerobutyricium hallii"))%>%
  mutate(condition = factor(condition, levels=c("control", "NIC-1", "NIC")))%>%
  # mutate(assay = factor(assay, levels =c(levels(order$assay))))%>%
  ggplot(aes(y=mean, x=condition))+
  theme(strip.text.y = element_text(angle=0))+
  geom_col(aes(fill=condition, position = condition), position = position_dodge(0.8), width=0.7)+
  geom_errorbar(aes(ymin=mean - sd, ymax=mean +sd, group=condition), width=.7, position=position_dodge(.9) )+
  stat_pvalue_manual(stats, label="p.adj.signif", coord.flip = TRUE, vjust=0.5, hide.ns = T,  y.position=35, step.increase = 0.1)+
  facet_grid(rows=vars(assay), scales = "free")+
  coord_flip()+
            xlab("Total C [mM]")-> total_C_plot


ggsave(filename = paste( "h2o2_pure cult_tot.jpeg"),
       path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/metabolites",
       width = 20,
       height = 40,
       units = c("cm"))

```


# 6. Perform T test & Shapiro Wilk test to check for normality

```{r}
#transform into long
HPLC_h2o2_long <-  gather(HPLC_wide_h2o2, metabolite, concentration, "succinate_rel_C":"butyrate_rel_C", factor_key = T ) 
```


```{r}

# stats<-as.data.frame(matrix(0,0,5))
# names(stats)<-c("condition_agar", "metabolite", "p", "p.signif", "Bacteria")

stats_h2o2<-matrix(0,0,5)
stats_h2o2_shapi<-matrix(0,0,5)
bacteria_names<- unique(HPLC_h2o2_long$assay)
metabol<- unique(HPLC_h2o2_long$metabolite)


wil<-"init"
out<-"init"
shapi_out<-"init"
shapi<-"init"



##filter out samples with no growth
HPLC_h2o2_long%>%
  subset(total_C >1)%>% #remove first col
  filter(!is.na(concentration))->HPLC_h2o2_long #get only teh metabolites that are actually produced

#loop for plots for all bacteria
for (i in 1:length(bacteria_names)) {
##create subset
  subset(HPLC_h2o2_long, assay == bacteria_names[i])->bacteria_subset
  #get the metabolites that are produced as a vector to loop over
  metabol<-unique(bacteria_subset$metabolite)
  
  for (j in 1:length(metabol)){
     subset(bacteria_subset, metabolite == metabol[j])->metabol_subset
    

#remove all df taht contain results
rm(wil) 
rm(out)
rm(shapi_out)
rm(shapi)

#do t test - try() to avoid interruption of loop in case t test cannot be performed (for zero value sor so) 
try(
  metabol_subset %>%
  t_test(data= .,
  formula = concentration ~ condition, ref.group = 
    "control")%>%
  add_significance()%>% 
  add_xy_position(x="metabolite") -> wil
  , 
  silent = T)
    
    
try(wil$Bacteria<- bacteria_names[i], silent=T)
try(wil$agar_condition<- cond[x], silent=T)
try(wil$metabolite<- metabol[j], silent=T)
try(out<-wil[, c( "metabolite",  "p.adj.signif", "Bacteria", "group2")], silent=T)

# do shapiro tets for the anaerobic and aerobic samples individually

    #get the agar conditions
   cond<-unique(metabol_subset$condition) 
    #loop over the agar conditions to create the final subset to bet tested
    for (z in 1:length(cond)){


try(
  metabol_subset%>%
    subset(condition %in% cond[z])%>%
     shapiro_test(concentration) -> shapi_out
  , silent = T)
  
try(shapi<-shapi_out[, c("p")], silent=T)
try(shapi$Bacteria<- bacteria_names[i], silent=T)
try(shapi$metabolite<- metabol[j], silent=T)
try(shapi$condition<- cond[z], silent=T)
try(stats_h2o2_shapi<-rbind(stats_h2o2_shapi, shapi), silent=T)}
   
try(stats_h2o2<-rbind(stats_h2o2, out), silent=T)

  }}

# stats_h2o2_shapi%>%
#   filter(p<0.05)



#to match the formate, pivot wider shapiro
shapiro_wide_h2o2<-setNames(pivot_wider(stats_h2o2_shapi, values_from = p, names_from = condition), c( "Bacteria", "metabolite", "p_shapiro_control", "NIC-1", "NIC"))%>%
  gather(condition, p_shapi, "NIC-1":"NIC")

left_join(setNames(stats_h2o2, c("metabolite", "p.adj.signif", "Bacteria", "condition")), shapiro_wide_h2o2)->stats_all_h2o2
```



## Merge mean values with statistics

```{r}
stats_all_h2o2$p_corrected<-stats_all_h2o2$p.adj.signif



for (i in 1:nrow(stats_all_h2o2)){

  
    if ( stats_all_h2o2[i,c("p_shapi")] < 0.05 | is.na(stats_all_h2o2[i,c("p_shapi")]) ){
    stats_all_h2o2[i,c("p_corrected")] ="ns"}
  
   if ( stats_all_h2o2[i,c("p_shapiro_control")] < 0.05 | is.na(stats_all_h2o2[i,c("p_shapiro_control")]) ){
    stats_all_h2o2[i,c("p_corrected")] ="ns"}
  
  # if (is.na(means_stats_h2o2[i, c("p")])== TRUE){
  # means_stats_h2o2[i,c("p_corrected")] ="ns"}
}

```

# 4. Calculate means & SD 
```{r}
left_join(
  setNames(aggregate(HPLC_h2o2_long$concentration, list(HPLC_h2o2_long$assay, HPLC_h2o2_long$metabolite, HPLC_h2o2_long$condition), FUN=mean, na.rm=T), c("Bacteria", "metabolite", "condition", "mean")),
setNames(aggregate(HPLC_h2o2_long$concentration, list(HPLC_h2o2_long$assay, HPLC_h2o2_long$metabolite, HPLC_h2o2_long$condition), FUN=sd, na.rm=T),
         c("Bacteria", "metabolite", "condition" ,"sd")))->means_h2o2

means_h2o2[,c("Bacteria", "metabolite", "condition", "mean")]%>%
  pivot_wider(names_from = condition, values_from = c(mean))%>%
  setNames(c("Bacteria", "metabolite", "mean_control", "mean_NIC", "mean_NIC_1"))->means_wide_h2o2

```

```{r}
means_wide_h2o2%>%
  mutate(NIC = mean_NIC - mean_control)%>%
  mutate(NIC_1 = `mean_NIC_1` - mean_control)%>%
  gather(condition, ratio, "NIC":"NIC_1")%>%
  mutate(mean_control = NULL,
        mean_NIC = NULL,
        mean_NIC_1 = NULL)%>%
  left_join(stats_all_h2o2)->ratio_h2o2

```


# 4. Calculate means of absolute values: to filter for metabolites that are of low concentration
```{r}

HPLC_wide_h2o2%>%
  gather(metabolite, concentration, "Succinat_.mM.": "Butyrat_.mM.")->abs_long


setNames(aggregate(abs_long$concentration, list(abs_long$assay,  abs_long$metabolite, abs_long$condition), FUN=mean), c("Bacteria", "metabolite", "condition", "mean_conc"))%>%
  pivot_wider(names_from = condition, values_from = mean_conc)%>%
  setNames(c("Bacteria",   "metabolite","mean_conc_control", "NIC", "NIC_1"))%>%
  gather(condition, mean_abs, "NIC":"NIC_1")%>%
  mutate(metabolite = ifelse(metabolite == "Acetat_.mM.", "acetate_rel_C", metabolite))%>%
  mutate(metabolite = ifelse(metabolite == "Butyrat_.mM.", "butyrate_rel_C", metabolite))%>%
  mutate(metabolite = ifelse(metabolite == "Propionat_.mM.", "propionate_rel_C", metabolite))%>%
  mutate(metabolite = ifelse(metabolite == "Succinat_.mM.", "succinate_rel_C", metabolite))%>%
  mutate(metabolite = ifelse(metabolite == "Lactat_.mM.", "lactate_rel_C", metabolite))%>%
   mutate(metabolite = ifelse(metabolite == "Formiat_.mM.", "formate_rel_C", metabolite))->means_absolute_h2O2 #machtch names of metabolites with ratio_O2 to perform left_join

```


```{r}
unique(ratio_h2o2$metabolite)

stats_absolute_h2o2<-left_join(ratio_h2o2, means_absolute_h2O2)

stats_absolute_h2o2$p_corrected_low_conc<-stats_absolute_h2o2$p_corrected

for (i in 1:nrow(stats_absolute_h2o2)){
  if (!is.na(stats_absolute_h2o2[i,"mean_conc_control"]) == T && 
      
      !is.na(stats_absolute_h2o2[i,"mean_abs"]) == T &&
      
      ((stats_absolute_h2o2[i,"mean_conc_control"] > -1 && 
        stats_absolute_h2o2[i,"mean_conc_control"] < 0 && 
        stats_absolute_h2o2[i,"mean_abs"] > -1 && 
        stats_absolute_h2o2[i,"mean_abs"] < 0) 
      || 
       (stats_absolute_h2o2[i,"mean_conc_control"] > 0 && 
        stats_absolute_h2o2[i,"mean_conc_control"] < 1 &&
        stats_absolute_h2o2[i,"mean_abs"] > 0 && 
        stats_absolute_h2o2[i,"mean_abs"] < 1))

      ) {
   stats_absolute_h2o2[i,"p_corrected_low_conc"] = "ns"
  }
}


```

## selection of the condition to analyze based on total metabolite production => go for the non-sig. different or the condition with the smallest difference
```{r}

```


```{r}
# taxonomy = read.csv(file = "P:/Shared_documents/Janina_Zuend/08_phd/12_working_package_2/Strain_panel.csv", sep=";", header=T, check.names =F)
# colnames(taxonomy)[colnames(taxonomy) == "bacteria"] <- "Bacteria"
# 
# tax<-left_join(selection[, -c(15)], taxonomy)
```


```{r}
# library(scales)
stats_absolute_h2o2%>%
    subset(!is.na(ratio))%>%
  mutate(p_corrected_low_conc = ifelse(p_corrected_low_conc == "ns", "", p_corrected_low_conc))%>%
 subset(!Bacteria %in% c("Subdoligranulum variabile", "Ruminococcus bromi", "Phascolarctobacterium succinatutens", "Anaerobutyricium hallii", "Marvinbryantiaformatixigens", "Anaerobutyricum hallii"))%>%
  mutate(metabolite = factor(metabolite, levels= c("succinate_rel_C","lactate_rel_C", "formate_rel_C" ,"acetate_rel_C","butyrate_rel_C","propionate_rel_C")))%>%
  mutate(ratio = ratio *100)->sub

max<-max(sub$ratio)
min<-min(sub$ratio)

sub%>%
  mutate(condition = factor(condition, levels=c("NIC_1", "NIC")))%>%
  ggplot(aes(x=metabolite, y=condition, fill=ratio))+
  geom_tile()+
  scale_fill_gradientn(colors = c( "coral", "white", "cyan4"),  na.value= "grey", values = rescale(c(min, 0, max)))+
  # scale_fill_gradientn(colors = c( "coral", "white", "cyan4"),  na.value= "grey", values = rescale(c(min, 0, max)))+
  facet_grid(rows=vars(Bacteria))+
    theme(strip.text.y = element_text(angle=0,  face="italic"),
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 90,  vjust=0.5, hjust=1),
        axis.text.y = element_text( face="italic"), 
        panel.border=element_rect(fill=NA), 
        panel.background = element_rect(fill="white"),
        legend.text.align = 0, 
        strip.background = element_blank(),
        panel.spacing = unit(0, "lines"))+
  scale_x_discrete(labels=c("succinate_rel_C"="succinate",  "lactate_rel_C" ="lactate" ,  "formate_rel_C"  ="formate" , "acetate_rel_C"  = "acetate" , "propionate_rel_C"="propionate", "butyrate_rel_C" = "butyrate"))+
  labs(fill="Delta [%]")+
  geom_text(aes(label=p_corrected_low_conc))-> diff_metabol_plot

ggsave(filename = "O2_heatplot_selection_lowconc.jpeg",   
         path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/metabolites", 
         width = 22,
         height = 40,
         units = c("cm"))

```


```{r}
# library(cowplot)
total_C_plot


plot_grid(diff_metabol_plot+theme(legend.position = "none", strip.text.y = element_blank()), 
          total_C_plot+theme(legend.position = "none", 
                             axis.text.y=element_blank(), 
                             axis.title.y=element_blank(), 
                             axis.ticks.y=element_blank(),
                          strip.text.y = element_text( face="italic", hjust=0), 
                             panel.border=element_rect(fill=NA), 
                             panel.background = element_rect(fill="white"),
                             legend.text.align = 0, 
                             strip.background = element_blank(),
                             panel.spacing = unit(0, "lines"), 
                          legend.title = element_blank())+
            scale_fill_manual(values=c( "deepskyblue2","indianred4","indianred"))+
            ylab("Total C [mM]") , 
        align= "h", rel_widths = c(0.7, 1), rel_heights = c(1,1), axis = 'tblr')

ggsave(filename = "metabolt_totalc.jpeg",   
         path = "C:/Users/zuendj/Desktop/03_data R/wp2_complex/output/metabolites", 
         width = 12,
         height = 30,
         units = c("cm"))
```







